#
# TidesDB INPLACE ALTER TABLE Tests
#
# Tests for ALGORITHM=INPLACE and ALGORITHM=INSTANT operations
#
DROP TABLE IF EXISTS tidesdb_check;
# Test 1: Create base table
CREATE TABLE t1 (
id INT PRIMARY KEY,
name VARCHAR(100),
value INT
) ENGINE=TidesDB;
INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 300);
# Test 2: ADD INDEX with ALGORITHM=INPLACE
ALTER TABLE t1 ADD INDEX idx_name (name), ALGORITHM=INPLACE;
Warnings:
Note	1071	Specified key was too long; max key length is 255 bytes
SHOW INDEX FROM t1;
Table	Non_unique	Key_name	Seq_in_index	Column_name	Collation	Cardinality	Sub_part	Packed	Null	Index_type	Comment	Index_comment	Ignored
t1	0	PRIMARY	1	id	A	3	NULL	NULL		LSMB+			NO
t1	1	idx_name	1	name	A	1	63	NULL	YES	LSMB+			NO
SELECT * FROM t1 WHERE name = 'Bob';
id	name	value
# Test 3: ADD UNIQUE INDEX with ALGORITHM=INPLACE
ALTER TABLE t1 ADD UNIQUE INDEX idx_value (value), ALGORITHM=INPLACE;
SHOW INDEX FROM t1;
Table	Non_unique	Key_name	Seq_in_index	Column_name	Collation	Cardinality	Sub_part	Packed	Null	Index_type	Comment	Index_comment	Ignored
t1	0	PRIMARY	1	id	A	3	NULL	NULL		LSMB+			NO
t1	0	idx_value	1	value	A	3	NULL	NULL	YES	LSMB+			NO
t1	1	idx_name	1	name	A	1	63	NULL	YES	LSMB+			NO
# Test 4: DROP INDEX with ALGORITHM=INPLACE
ALTER TABLE t1 DROP INDEX idx_name, ALGORITHM=INPLACE;
SHOW INDEX FROM t1;
Table	Non_unique	Key_name	Seq_in_index	Column_name	Collation	Cardinality	Sub_part	Packed	Null	Index_type	Comment	Index_comment	Ignored
t1	0	PRIMARY	1	id	A	3	NULL	NULL		LSMB+			NO
t1	0	idx_value	1	value	A	3	NULL	NULL	YES	LSMB+			NO
# Test 5: RENAME INDEX with ALGORITHM=INSTANT
ALTER TABLE t1 RENAME INDEX idx_value TO idx_val, ALGORITHM=INSTANT;
SHOW INDEX FROM t1;
Table	Non_unique	Key_name	Seq_in_index	Column_name	Collation	Cardinality	Sub_part	Packed	Null	Index_type	Comment	Index_comment	Ignored
t1	0	PRIMARY	1	id	A	3	NULL	NULL		LSMB+			NO
t1	0	idx_val	1	value	A	3	NULL	NULL	YES	LSMB+			NO
# Test 6: Change column default with ALGORITHM=INSTANT
ALTER TABLE t1 ALTER COLUMN value SET DEFAULT 0, ALGORITHM=INSTANT;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT NULL,
  `value` int(11) DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_val` (`value`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
# Test 7: Table comment with ALGORITHM=INSTANT
ALTER TABLE t1 COMMENT='Test table for INPLACE operations', ALGORITHM=INSTANT;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT NULL,
  `value` int(11) DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_val` (`value`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table for INPLACE operations'
# Test 8: Multiple index operations in one ALTER
DROP TABLE t1;
CREATE TABLE t1 (
id INT PRIMARY KEY,
a INT,
b INT,
c INT
) ENGINE=TidesDB;
INSERT INTO t1 VALUES (1, 10, 20, 30), (2, 40, 50, 60), (3, 70, 80, 90);
ALTER TABLE t1 
ADD INDEX idx_a (a),
ADD INDEX idx_b (b),
ADD INDEX idx_c (c),
ALGORITHM=INPLACE;
SHOW INDEX FROM t1;
Table	Non_unique	Key_name	Seq_in_index	Column_name	Collation	Cardinality	Sub_part	Packed	Null	Index_type	Comment	Index_comment	Ignored
t1	0	PRIMARY	1	id	A	3	NULL	NULL		LSMB+			NO
t1	1	idx_a	1	a	A	1	NULL	NULL	YES	LSMB+			NO
t1	1	idx_b	1	b	A	1	NULL	NULL	YES	LSMB+			NO
t1	1	idx_c	1	c	A	1	NULL	NULL	YES	LSMB+			NO
# Test 9: Verify indexes work after INPLACE ADD
SELECT * FROM t1 WHERE a = 40;
id	a	b	c
SELECT * FROM t1 WHERE b = 50;
id	a	b	c
SELECT * FROM t1 WHERE c = 90;
id	a	b	c
# Test 10: DROP multiple indexes
ALTER TABLE t1 
DROP INDEX idx_a,
DROP INDEX idx_b,
ALGORITHM=INPLACE;
SHOW INDEX FROM t1;
Table	Non_unique	Key_name	Seq_in_index	Column_name	Collation	Cardinality	Sub_part	Packed	Null	Index_type	Comment	Index_comment	Ignored
t1	0	PRIMARY	1	id	A	3	NULL	NULL		LSMB+			NO
t1	1	idx_c	1	c	A	1	NULL	NULL	YES	LSMB+			NO
# Cleanup
DROP TABLE t1;
#
# INPLACE ALTER tests completed!
#
