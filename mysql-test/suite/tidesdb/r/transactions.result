#
# TidesDB Transaction Tests
#
DROP TABLE IF EXISTS tidesdb_check;
# Test 1: Basic transaction commit
CREATE TABLE t1 (id INT PRIMARY KEY, value INT) ENGINE=TidesDB;
START TRANSACTION;
INSERT INTO t1 VALUES (1, 100);
INSERT INTO t1 VALUES (2, 200);
SELECT * FROM t1 ORDER BY id;
id	value
1	100
COMMIT;
SELECT * FROM t1 ORDER BY id;
id	value
1	100
2	200
# Test 2: Basic transaction rollback
START TRANSACTION;
INSERT INTO t1 VALUES (3, 300);
INSERT INTO t1 VALUES (4, 400);
SELECT * FROM t1 ORDER BY id;
id	value
1	100
2	200
3	300
4	400
ROLLBACK;
SELECT * FROM t1 ORDER BY id;
id	value
1	100
2	200
# Test 3: Savepoint and rollback to savepoint
START TRANSACTION;
INSERT INTO t1 VALUES (10, 1000);
SAVEPOINT sp1;
INSERT INTO t1 VALUES (11, 1100);
SAVEPOINT sp2;
INSERT INTO t1 VALUES (12, 1200);
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;
id	value
10	1000
11	1100
12	1200
ROLLBACK TO SAVEPOINT sp2;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;
id	value
10	1000
11	1100
ROLLBACK TO SAVEPOINT sp1;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;
id	value
10	1000
COMMIT;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;
id	value
10	1000
# Test 4: Release savepoint
START TRANSACTION;
INSERT INTO t1 VALUES (20, 2000);
SAVEPOINT sp_release;
INSERT INTO t1 VALUES (21, 2100);
RELEASE SAVEPOINT sp_release;
COMMIT;
SELECT * FROM t1 WHERE id >= 20 ORDER BY id;
id	value
20	2000
21	2100
# Test 5: Nested savepoints
START TRANSACTION;
INSERT INTO t1 VALUES (30, 3000);
SAVEPOINT outer_sp;
INSERT INTO t1 VALUES (31, 3100);
SAVEPOINT inner_sp;
INSERT INTO t1 VALUES (32, 3200);
ROLLBACK TO SAVEPOINT inner_sp;
INSERT INTO t1 VALUES (33, 3300);
COMMIT;
SELECT * FROM t1 WHERE id >= 30 ORDER BY id;
id	value
30	3000
31	3100
33	3300
# Test 6: Update within transaction
START TRANSACTION;
UPDATE t1 SET value = 999 WHERE id = 1;
SELECT * FROM t1 WHERE id = 1;
id	value
1	999
ROLLBACK;
SELECT * FROM t1 WHERE id = 1;
id	value
1	100
START TRANSACTION;
UPDATE t1 SET value = 888 WHERE id = 1;
COMMIT;
SELECT * FROM t1 WHERE id = 1;
id	value
1	888
# Test 7: Delete within transaction
START TRANSACTION;
DELETE FROM t1 WHERE id = 2;
SELECT COUNT(*) FROM t1 WHERE id = 2;
COUNT(*)
0
ROLLBACK;
SELECT COUNT(*) FROM t1 WHERE id = 2;
COUNT(*)
1
# Test 8: Mixed operations in transaction
START TRANSACTION;
INSERT INTO t1 VALUES (40, 4000);
UPDATE t1 SET value = 4001 WHERE id = 40;
DELETE FROM t1 WHERE id = 10;
SELECT * FROM t1 WHERE id IN (10, 40) ORDER BY id;
id	value
40	4001
COMMIT;
SELECT * FROM t1 WHERE id IN (10, 40) ORDER BY id;
id	value
40	4001
# Test 9: Autocommit mode
SET autocommit = 0;
INSERT INTO t1 VALUES (50, 5000);
SELECT * FROM t1 WHERE id = 50;
id	value
50	5000
ROLLBACK;
SELECT * FROM t1 WHERE id = 50;
id	value
INSERT INTO t1 VALUES (51, 5100);
COMMIT;
SELECT * FROM t1 WHERE id = 51;
id	value
51	5100
SET autocommit = 1;
# Cleanup
DROP TABLE t1;
#
# Transaction tests completed!
#
