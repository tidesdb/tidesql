#
# TidesDB Partitioning Tests
#
# Tests for table partitioning support:
# - RANGE partitioning
# - LIST partitioning
# - HASH partitioning
# - Partition pruning
#
DROP TABLE IF EXISTS tidesdb_check;
# Test 1: RANGE partitioning
CREATE TABLE t_range (
id INT,
name VARCHAR(50),
created_date DATE,
PRIMARY KEY (id, created_date)
) ENGINE=TidesDB
PARTITION BY RANGE (YEAR(created_date)) (
PARTITION p2020 VALUES LESS THAN (2021),
PARTITION p2021 VALUES LESS THAN (2022),
PARTITION p2022 VALUES LESS THAN (2023),
PARTITION p2023 VALUES LESS THAN (2024),
PARTITION pmax VALUES LESS THAN MAXVALUE
);
SHOW CREATE TABLE t_range;
Table	t_range
Create Table	CREATE TABLE `t_range` (
  `id` int(11) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `created_date` date NOT NULL,
  PRIMARY KEY (`id`,`created_date`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
 PARTITION BY RANGE (year(`created_date`))
(PARTITION `p2020` VALUES LESS THAN (2021) ENGINE = TidesDB,
 PARTITION `p2021` VALUES LESS THAN (2022) ENGINE = TidesDB,
 PARTITION `p2022` VALUES LESS THAN (2023) ENGINE = TidesDB,
 PARTITION `p2023` VALUES LESS THAN (2024) ENGINE = TidesDB,
 PARTITION `pmax` VALUES LESS THAN MAXVALUE ENGINE = TidesDB)
# Insert data into different partitions
INSERT INTO t_range VALUES (1, 'Row 2020', '2020-06-15');
INSERT INTO t_range VALUES (2, 'Row 2021', '2021-03-20');
INSERT INTO t_range VALUES (3, 'Row 2022', '2022-09-10');
INSERT INTO t_range VALUES (4, 'Row 2023', '2023-01-05');
INSERT INTO t_range VALUES (5, 'Row 2024', '2024-07-22');
SELECT * FROM t_range ORDER BY id;
id	name	created_date
1	Row 2020	2020-06-15
2	Row 2021	2021-03-20
3	Row 2022	2022-09-10
4	Row 2023	2023-01-05
5	Row 2024	2024-07-22
# Test partition pruning
EXPLAIN PARTITIONS SELECT * FROM t_range WHERE created_date = '2022-09-10';
id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t_range	p2022	system	NULL	NULL	NULL	NULL	1	
# Test 2: LIST partitioning
CREATE TABLE t_list (
id INT,
region VARCHAR(20),
sales DECIMAL(10,2),
PRIMARY KEY (id, region)
) ENGINE=TidesDB
PARTITION BY LIST COLUMNS (region) (
PARTITION p_east VALUES IN ('NY', 'NJ', 'CT'),
PARTITION p_west VALUES IN ('CA', 'WA', 'OR'),
PARTITION p_central VALUES IN ('TX', 'IL', 'OH')
);
INSERT INTO t_list VALUES (1, 'NY', 1000.00);
INSERT INTO t_list VALUES (2, 'CA', 2000.00);
INSERT INTO t_list VALUES (3, 'TX', 1500.00);
INSERT INTO t_list VALUES (4, 'WA', 1800.00);
INSERT INTO t_list VALUES (5, 'IL', 1200.00);
SELECT * FROM t_list ORDER BY id;
id	region	sales
1	NY	1000.00
2	CA	2000.00
3	TX	1500.00
4	WA	1800.00
5	IL	1200.00
# Query specific partition
SELECT * FROM t_list PARTITION (p_west) ORDER BY id;
id	region	sales
2	CA	2000.00
4	WA	1800.00
# Test 3: HASH partitioning
CREATE TABLE t_hash (
id INT PRIMARY KEY,
data VARCHAR(100)
) ENGINE=TidesDB
PARTITION BY HASH(id)
PARTITIONS 4;
INSERT INTO t_hash VALUES (1, 'Data 1');
INSERT INTO t_hash VALUES (2, 'Data 2');
INSERT INTO t_hash VALUES (3, 'Data 3');
INSERT INTO t_hash VALUES (4, 'Data 4');
INSERT INTO t_hash VALUES (5, 'Data 5');
INSERT INTO t_hash VALUES (6, 'Data 6');
INSERT INTO t_hash VALUES (7, 'Data 7');
INSERT INTO t_hash VALUES (8, 'Data 8');
SELECT * FROM t_hash ORDER BY id;
id	data
1	Data 1
2	Data 2
3	Data 3
4	Data 4
5	Data 5
6	Data 6
7	Data 7
8	Data 8
# Test 4: KEY partitioning
CREATE TABLE t_key (
id INT,
name VARCHAR(50),
PRIMARY KEY (id)
) ENGINE=TidesDB
PARTITION BY KEY(id)
PARTITIONS 3;
INSERT INTO t_key VALUES (1, 'Alice');
INSERT INTO t_key VALUES (2, 'Bob');
INSERT INTO t_key VALUES (3, 'Charlie');
INSERT INTO t_key VALUES (4, 'David');
INSERT INTO t_key VALUES (5, 'Eve');
SELECT * FROM t_key ORDER BY id;
id	name
1	Alice
2	Bob
3	Charlie
4	David
5	Eve
# Test 5: DROP PARTITION
ALTER TABLE t_range DROP PARTITION p2020;
SELECT * FROM t_range ORDER BY id;
id	name	created_date
2	Row 2021	2021-03-20
3	Row 2022	2022-09-10
4	Row 2023	2023-01-05
5	Row 2024	2024-07-22
# Test 6: TRUNCATE PARTITION
INSERT INTO t_range VALUES (7, 'Another 2023', '2023-12-01');
SELECT COUNT(*) FROM t_range PARTITION (p2023);
COUNT(*)
2
ALTER TABLE t_range TRUNCATE PARTITION p2023;
SELECT COUNT(*) FROM t_range PARTITION (p2023);
COUNT(*)
0
# Test 7: REORGANIZE PARTITION to add new partitions
ALTER TABLE t_range REORGANIZE PARTITION pmax INTO (
PARTITION p2024 VALUES LESS THAN (2025),
PARTITION p2025 VALUES LESS THAN (2026),
PARTITION pmax VALUES LESS THAN MAXVALUE
);
# Insert into new partition
INSERT INTO t_range VALUES (6, 'Row 2025', '2025-05-15');
SELECT * FROM t_range WHERE YEAR(created_date) = 2025;
id	name	created_date
6	Row 2025	2025-05-15
SHOW CREATE TABLE t_range;
Table	t_range
Create Table	CREATE TABLE `t_range` (
  `id` int(11) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `created_date` date NOT NULL,
  PRIMARY KEY (`id`,`created_date`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci
 PARTITION BY RANGE (year(`created_date`))
(PARTITION `p2021` VALUES LESS THAN (2022) ENGINE = TidesDB,
 PARTITION `p2022` VALUES LESS THAN (2023) ENGINE = TidesDB,
 PARTITION `p2023` VALUES LESS THAN (2024) ENGINE = TidesDB,
 PARTITION `p2024` VALUES LESS THAN (2025) ENGINE = TidesDB,
 PARTITION `p2025` VALUES LESS THAN (2026) ENGINE = TidesDB,
 PARTITION `pmax` VALUES LESS THAN MAXVALUE ENGINE = TidesDB)
# Cleanup
DROP TABLE t_range;
DROP TABLE t_list;
DROP TABLE t_hash;
DROP TABLE t_key;
#
# Partitioning tests completed!
#
