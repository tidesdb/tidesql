#
# Test SELECT FOR UPDATE SKIP LOCKED (HA_CAN_SKIP_LOCKED)
#
DROP TABLE tidesdb_check;
CREATE TABLE t1 (
id INT PRIMARY KEY,
value VARCHAR(100)
) ENGINE=TidesDB;
INSERT INTO t1 VALUES (1, 'row1');
INSERT INTO t1 VALUES (2, 'row2');
INSERT INTO t1 VALUES (3, 'row3');
INSERT INTO t1 VALUES (4, 'row4');
INSERT INTO t1 VALUES (5, 'row5');
# Test 1: Basic SELECT FOR UPDATE
START TRANSACTION;
SELECT * FROM t1 WHERE id = 1 FOR UPDATE;
id	value
1	row1
COMMIT;
# Test 2: SELECT FOR UPDATE SKIP LOCKED
START TRANSACTION;
SELECT * FROM t1 WHERE id IN (1, 2, 3) FOR UPDATE SKIP LOCKED;
id	value
1	row1
2	row2
3	row3
COMMIT;
# Test 3: SELECT FOR UPDATE NOWAIT
START TRANSACTION;
SELECT * FROM t1 WHERE id = 2 FOR UPDATE NOWAIT;
id	value
2	row2
COMMIT;
# Test 4: Concurrent access with SKIP LOCKED
connect  con1, localhost, root,,;
connection con1;
START TRANSACTION;
SELECT * FROM t1 WHERE id = 1 FOR UPDATE;
id	value
1	row1
connection default;
START TRANSACTION;
SELECT * FROM t1 WHERE id IN (1, 2) FOR UPDATE SKIP LOCKED;
id	value
1	row1
2	row2
COMMIT;
connection con1;
COMMIT;
disconnect con1;
connection default;
# Cleanup
DROP TABLE t1;
#
# SKIP LOCKED tests completed!
#
