#
# TidesDB Secondary Index Tests
#
DROP TABLE IF EXISTS tidesdb_check;
# Test 1: Single column index
CREATE TABLE t1 (
id INT PRIMARY KEY,
name VARCHAR(100),
age INT,
INDEX idx_name (name),
INDEX idx_age (age)
) ENGINE=TidesDB;
Warnings:
Note	1071	Specified key was too long; max key length is 255 bytes
INSERT INTO t1 VALUES (1, 'Alice', 25);
INSERT INTO t1 VALUES (2, 'Bob', 30);
INSERT INTO t1 VALUES (3, 'Charlie', 25);
INSERT INTO t1 VALUES (4, 'David', 35);
INSERT INTO t1 VALUES (5, 'Alice', 28);
# Test 2: Index lookup
SELECT * FROM t1 WHERE name = 'Alice' ORDER BY id;
id	name	age
1	Alice	25
5	Alice	28
SELECT * FROM t1 WHERE age = 25 ORDER BY id;
id	name	age
1	Alice	25
3	Charlie	25
# Test 3: Index range scan
SELECT * FROM t1 WHERE age >= 28 ORDER BY age;
id	name	age
5	Alice	28
2	Bob	30
4	David	35
SELECT * FROM t1 WHERE name >= 'C' ORDER BY name;
id	name	age
3	Charlie	25
4	David	35
# Test 4: Composite index
CREATE TABLE t2 (
id INT PRIMARY KEY,
first_name VARCHAR(50),
last_name VARCHAR(50),
city VARCHAR(50),
INDEX idx_name (first_name, last_name),
INDEX idx_city (city)
) ENGINE=TidesDB;
INSERT INTO t2 VALUES (1, 'John', 'Doe', 'New York');
INSERT INTO t2 VALUES (2, 'Jane', 'Doe', 'Los Angeles');
INSERT INTO t2 VALUES (3, 'John', 'Smith', 'Chicago');
INSERT INTO t2 VALUES (4, 'Jane', 'Smith', 'New York');
INSERT INTO t2 VALUES (5, 'Bob', 'Johnson', 'Chicago');
# Test 5: Composite index lookup
SELECT * FROM t2 WHERE first_name = 'John' ORDER BY id;
id	first_name	last_name	city
1	John	Doe	New York
3	John	Smith	Chicago
SELECT * FROM t2 WHERE first_name = 'John' AND last_name = 'Doe';
id	first_name	last_name	city
1	John	Doe	New York
SELECT * FROM t2 WHERE first_name = 'Jane' AND last_name = 'Smith';
id	first_name	last_name	city
4	Jane	Smith	New York
# Test 6: Index with NULL values
CREATE TABLE t3 (
id INT PRIMARY KEY,
nullable_col VARCHAR(50),
INDEX idx_nullable (nullable_col)
) ENGINE=TidesDB;
INSERT INTO t3 VALUES (1, 'value1');
INSERT INTO t3 VALUES (2, NULL);
INSERT INTO t3 VALUES (3, 'value2');
INSERT INTO t3 VALUES (4, NULL);
INSERT INTO t3 VALUES (5, 'value1');
SELECT * FROM t3 WHERE nullable_col IS NULL ORDER BY id;
id	nullable_col
SELECT * FROM t3 WHERE nullable_col = 'value1' ORDER BY id;
id	nullable_col
1	value1
5	value1
# Test 7: Update indexed column
UPDATE t1 SET name = 'Alicia' WHERE id = 1;
SELECT * FROM t1 WHERE name = 'Alice' ORDER BY id;
id	name	age
5	Alice	28
SELECT * FROM t1 WHERE name = 'Alicia';
id	name	age
1	Alicia	25
# Test 8: Delete with index
DELETE FROM t1 WHERE name = 'Bob';
SELECT * FROM t1 ORDER BY id;
id	name	age
1	Alicia	25
3	Charlie	25
4	David	35
5	Alice	28
# Test 9: Index on different data types
CREATE TABLE t4 (
id INT PRIMARY KEY,
int_col INT,
bigint_col BIGINT,
date_col DATE,
INDEX idx_int (int_col),
INDEX idx_bigint (bigint_col),
INDEX idx_date (date_col)
) ENGINE=TidesDB;
INSERT INTO t4 VALUES (1, 100, 1000000000000, '2024-01-15');
INSERT INTO t4 VALUES (2, 200, 2000000000000, '2024-02-20');
INSERT INTO t4 VALUES (3, 100, 3000000000000, '2024-01-15');
SELECT * FROM t4 WHERE int_col = 100 ORDER BY id;
id	int_col	bigint_col	date_col
1	100	1000000000000	2024-01-15
3	100	3000000000000	2024-01-15
SELECT * FROM t4 WHERE date_col = '2024-01-15' ORDER BY id;
id	int_col	bigint_col	date_col
1	100	1000000000000	2024-01-15
3	100	3000000000000	2024-01-15
# Test 10: EXPLAIN shows index usage
EXPLAIN SELECT * FROM t1 WHERE name = 'Charlie';
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ref	idx_name	idx_name	255	const	1	Using where with pushed condition
EXPLAIN SELECT * FROM t2 WHERE first_name = 'John' AND last_name = 'Doe';
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t2	ref	idx_name	idx_name	406	const,const	1	
# Cleanup
DROP TABLE t1, t2, t3, t4;
#
# Secondary index tests completed!
#
