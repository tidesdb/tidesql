#
# TidesDB check_if_incompatible_data Tests
#
# Tests that metadata-only ALTERs avoid unnecessary table rebuilds.
#
DROP TABLE IF EXISTS tidesdb_check;
# Test 1: Create test table
CREATE TABLE t1 (
id INT PRIMARY KEY,
name VARCHAR(100) DEFAULT 'unknown',
value INT
) ENGINE=TidesDB;
INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 300);
# Test 2: ALTER TABLE COMMENT (metadata only, should not rebuild)
ALTER TABLE t1 COMMENT='Test table with comment';
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT 'unknown',
  `value` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table with comment'
SELECT * FROM t1 ORDER BY id;
id	name	value
1	Alice	100
2	Bob	200
3	Charlie	300
# Test 3: ALTER TABLE change default value (metadata only)
ALTER TABLE t1 ALTER COLUMN name SET DEFAULT 'no_name';
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT 'no_name',
  `value` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table with comment'
SELECT * FROM t1 ORDER BY id;
id	name	value
1	Alice	100
2	Bob	200
3	Charlie	300
# Test 4: ALTER TABLE rename column (instant)
ALTER TABLE t1 RENAME COLUMN value TO amount;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT 'no_name',
  `amount` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table with comment'
SELECT * FROM t1 ORDER BY id;
id	name	amount
1	Alice	100
2	Bob	200
3	Charlie	300
# Test 5: ALTER TABLE rename table (instant)
ALTER TABLE t1 RENAME TO t1_renamed;
SELECT * FROM t1_renamed ORDER BY id;
id	name	amount
1	Alice	100
2	Bob	200
3	Charlie	300
# Test 6: Rename back
ALTER TABLE t1_renamed RENAME TO t1;
# Test 7: ALTER TABLE ADD INDEX (inplace, not copy)
ALTER TABLE t1 ADD INDEX idx_name (name);
Warnings:
Note	1071	Specified key was too long; max key length is 255 bytes
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT 'no_name',
  `amount` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`(63))
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table with comment'
SELECT * FROM t1 ORDER BY id;
id	name	amount
1	Alice	100
2	Bob	200
3	Charlie	300
# Test 8: ALTER TABLE DROP INDEX (inplace)
ALTER TABLE t1 DROP INDEX idx_name;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT 'no_name',
  `amount` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table with comment'
# Test 9: ALTER TABLE ADD COLUMN (requires copy -- stored column)
ALTER TABLE t1 ADD COLUMN extra VARCHAR(50);
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `id` int(11) NOT NULL,
  `name` varchar(100) DEFAULT 'no_name',
  `amount` int(11) DEFAULT NULL,
  `extra` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=TidesDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_uca1400_ai_ci COMMENT='Test table with comment'
SELECT * FROM t1 ORDER BY id;
id	name	amount	extra
1	Alice	100	NULL
2	Bob	200	NULL
3	Charlie	300	NULL
# Test 10: Data integrity after all ALTERs
SELECT COUNT(*) FROM t1;
COUNT(*)
3
# Cleanup
DROP TABLE t1;
#
# Compatible data tests completed!
#
