--echo #
--echo # TidesDB Transaction Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Basic transaction commit
CREATE TABLE t1 (id INT PRIMARY KEY, value INT) ENGINE=TidesDB;

START TRANSACTION;
INSERT INTO t1 VALUES (1, 100);
INSERT INTO t1 VALUES (2, 200);
SELECT * FROM t1 ORDER BY id;
COMMIT;
SELECT * FROM t1 ORDER BY id;

--echo # Test 2: Basic transaction rollback
START TRANSACTION;
INSERT INTO t1 VALUES (3, 300);
INSERT INTO t1 VALUES (4, 400);
SELECT * FROM t1 ORDER BY id;
ROLLBACK;
SELECT * FROM t1 ORDER BY id;

--echo # Test 3: Savepoint and rollback to savepoint
START TRANSACTION;
INSERT INTO t1 VALUES (10, 1000);
SAVEPOINT sp1;
INSERT INTO t1 VALUES (11, 1100);
SAVEPOINT sp2;
INSERT INTO t1 VALUES (12, 1200);
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;

ROLLBACK TO SAVEPOINT sp2;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;

ROLLBACK TO SAVEPOINT sp1;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;

COMMIT;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;

--echo # Test 4: Release savepoint
START TRANSACTION;
INSERT INTO t1 VALUES (20, 2000);
SAVEPOINT sp_release;
INSERT INTO t1 VALUES (21, 2100);
RELEASE SAVEPOINT sp_release;
COMMIT;
SELECT * FROM t1 WHERE id >= 20 ORDER BY id;

--echo # Test 5: Nested savepoints
START TRANSACTION;
INSERT INTO t1 VALUES (30, 3000);
SAVEPOINT outer_sp;
INSERT INTO t1 VALUES (31, 3100);
SAVEPOINT inner_sp;
INSERT INTO t1 VALUES (32, 3200);
ROLLBACK TO SAVEPOINT inner_sp;
INSERT INTO t1 VALUES (33, 3300);
COMMIT;
SELECT * FROM t1 WHERE id >= 30 ORDER BY id;

--echo # Test 6: Update within transaction
START TRANSACTION;
UPDATE t1 SET value = 999 WHERE id = 1;
SELECT * FROM t1 WHERE id = 1;
ROLLBACK;
SELECT * FROM t1 WHERE id = 1;

START TRANSACTION;
UPDATE t1 SET value = 888 WHERE id = 1;
COMMIT;
SELECT * FROM t1 WHERE id = 1;

--echo # Test 7: Delete within transaction
START TRANSACTION;
DELETE FROM t1 WHERE id = 2;
SELECT COUNT(*) FROM t1 WHERE id = 2;
ROLLBACK;
SELECT COUNT(*) FROM t1 WHERE id = 2;

--echo # Test 8: Mixed operations in transaction
START TRANSACTION;
INSERT INTO t1 VALUES (40, 4000);
UPDATE t1 SET value = 4001 WHERE id = 40;
DELETE FROM t1 WHERE id = 10;
SELECT * FROM t1 WHERE id IN (10, 40) ORDER BY id;
COMMIT;
SELECT * FROM t1 WHERE id IN (10, 40) ORDER BY id;

--echo # Test 9: Autocommit mode
SET autocommit = 0;
INSERT INTO t1 VALUES (50, 5000);
SELECT * FROM t1 WHERE id = 50;
ROLLBACK;
SELECT * FROM t1 WHERE id = 50;

INSERT INTO t1 VALUES (51, 5100);
COMMIT;
SELECT * FROM t1 WHERE id = 51;
SET autocommit = 1;

--echo # Cleanup
DROP TABLE t1;

--echo #
--echo # Transaction tests completed!
--echo #
