--echo #
--echo # TidesDB Foreign Key Parent List Tests
--echo #
--echo # Tests get_foreign_key_list(), get_parent_foreign_key_list(),
--echo # and referenced_by_foreign_key() functionality.
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create parent and child tables
CREATE TABLE parent_t (
  id INT PRIMARY KEY,
  name VARCHAR(50)
) ENGINE=TidesDB;

CREATE TABLE child_t (
  id INT PRIMARY KEY,
  parent_id INT,
  value VARCHAR(50),
  FOREIGN KEY fk_parent (parent_id) REFERENCES parent_t(id) ON DELETE CASCADE
) ENGINE=TidesDB;

--echo # Test 2: Verify FK visible via SHOW CREATE TABLE
SHOW CREATE TABLE child_t;

--echo # Test 3: Verify FK visible via INFORMATION_SCHEMA
SELECT CONSTRAINT_NAME, TABLE_NAME, REFERENCED_TABLE_NAME
FROM information_schema.REFERENTIAL_CONSTRAINTS
WHERE TABLE_NAME = 'child_t' AND CONSTRAINT_SCHEMA = DATABASE();

--echo # Test 4: Insert data respecting FK
INSERT INTO parent_t VALUES (1, 'Parent 1');
INSERT INTO parent_t VALUES (2, 'Parent 2');
INSERT INTO child_t VALUES (1, 1, 'Child of 1');
INSERT INTO child_t VALUES (2, 2, 'Child of 2');

SELECT * FROM parent_t ORDER BY id;
SELECT * FROM child_t ORDER BY id;

--echo # Test 5: ALTER TABLE on parent (tests get_parent_foreign_key_list)
ALTER TABLE parent_t ADD COLUMN extra VARCHAR(50);
SHOW CREATE TABLE parent_t;
SELECT * FROM parent_t ORDER BY id;

--echo # Test 6: ALTER TABLE on child (tests get_foreign_key_list)
ALTER TABLE child_t ADD COLUMN notes VARCHAR(50);
SHOW CREATE TABLE child_t;
SELECT * FROM child_t ORDER BY id;

--echo # Test 7: Multiple children referencing same parent
CREATE TABLE child_t2 (
  id INT PRIMARY KEY,
  parent_id INT,
  data VARCHAR(50),
  FOREIGN KEY fk_parent2 (parent_id) REFERENCES parent_t(id) ON DELETE SET NULL
) ENGINE=TidesDB;

INSERT INTO child_t2 VALUES (1, 1, 'Second child of 1');

--echo # Test 8: ALTER parent with multiple children referencing it
ALTER TABLE parent_t ADD COLUMN status INT DEFAULT 0;
SHOW CREATE TABLE parent_t;

--echo # Test 9: Self-referencing FK
CREATE TABLE tree_t (
  id INT PRIMARY KEY,
  parent_id INT,
  name VARCHAR(50),
  FOREIGN KEY fk_self (parent_id) REFERENCES tree_t(id) ON DELETE SET NULL
) ENGINE=TidesDB;

INSERT INTO tree_t VALUES (1, NULL, 'Root');
INSERT INTO tree_t VALUES (2, 1, 'Child 1');
INSERT INTO tree_t VALUES (3, 1, 'Child 2');
INSERT INTO tree_t VALUES (4, 2, 'Grandchild');

SELECT * FROM tree_t ORDER BY id;

--echo # Test 10: ALTER self-referencing table
ALTER TABLE tree_t ADD COLUMN depth INT;
SHOW CREATE TABLE tree_t;
SELECT * FROM tree_t ORDER BY id;

--echo # Cleanup
DROP TABLE child_t2;
DROP TABLE child_t;
DROP TABLE parent_t;
DROP TABLE tree_t;

--echo #
--echo # FK parent list tests completed!
--echo #
