--echo #
--echo # TidesDB Index Operations Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create table with index
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  value INT,
  INDEX idx_name (name),
  INDEX idx_value (value)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 150);
INSERT INTO t1 VALUES (4, 'David', 300);
INSERT INTO t1 VALUES (5, 'Eve', 250);

--echo # Test 2: index_first - Get first row via index
SELECT * FROM t1 USE INDEX (idx_value) ORDER BY value LIMIT 1;

--echo # Test 3: index_last - Get last row via index  
SELECT * FROM t1 USE INDEX (idx_value) ORDER BY value DESC LIMIT 1;

--echo # Test 4: index_next - Sequential index scan
SELECT * FROM t1 USE INDEX (idx_value) WHERE value >= 150 ORDER BY value;

--echo # Test 5: index_prev - Reverse index scan
SELECT * FROM t1 USE INDEX (idx_value) WHERE value <= 250 ORDER BY value DESC;

--echo # Test 6: index_read with different find flags
# HA_READ_KEY_EXACT
SELECT * FROM t1 WHERE name = 'Charlie';

# HA_READ_KEY_OR_NEXT  
SELECT * FROM t1 USE INDEX (idx_name) WHERE name >= 'C' ORDER BY name LIMIT 3;

# HA_READ_KEY_OR_PREV
SELECT * FROM t1 USE INDEX (idx_name) WHERE name <= 'C' ORDER BY name DESC LIMIT 3;

--echo # Test 7: index_next_same - Multiple rows with same key
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  category VARCHAR(50),
  item VARCHAR(100),
  INDEX idx_category (category)
) ENGINE=TidesDB;

INSERT INTO t2 VALUES (1, 'Electronics', 'Phone');
INSERT INTO t2 VALUES (2, 'Electronics', 'Laptop');
INSERT INTO t2 VALUES (3, 'Electronics', 'Tablet');
INSERT INTO t2 VALUES (4, 'Clothing', 'Shirt');
INSERT INTO t2 VALUES (5, 'Clothing', 'Pants');

SELECT * FROM t2 WHERE category = 'Electronics' ORDER BY id;

--echo # Test 8: Range scan with BETWEEN
SELECT * FROM t1 WHERE value BETWEEN 150 AND 250 ORDER BY value;

--echo # Test 9: Index with ORDER BY
SELECT * FROM t1 ORDER BY name;
SELECT * FROM t1 ORDER BY value DESC;

--echo # Test 10: Index with LIMIT
SELECT * FROM t1 ORDER BY value LIMIT 3;
SELECT * FROM t1 ORDER BY value DESC LIMIT 2;

--echo # Test 11: Covering index (index-only scan)
SELECT name FROM t1 WHERE name LIKE 'A%';
SELECT value FROM t1 WHERE value > 200;

--echo # Cleanup
DROP TABLE t1, t2;

--echo #
--echo # Index operations tests completed!
--echo #
