--echo #
--echo # TidesDB Sequential Scan Prefetch (HA_EXTRA_CACHE) Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Full table scan triggers prefetch (HA_EXTRA_CACHE)
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  data VARCHAR(255)
) ENGINE=TidesDB;

--disable_query_log
let $i = 1;
while ($i <= 500)
{
  eval INSERT INTO t1 VALUES ($i, CONCAT('prefetch_data_', $i));
  inc $i;
}
--enable_query_log

--echo # Full scan -- optimizer sends HA_EXTRA_CACHE before scan
SELECT COUNT(*) FROM t1;
SELECT COUNT(*) FROM t1 WHERE data LIKE 'prefetch_data_25%';

--echo # Test 2: Prefetch with ORDER BY (filesort triggers cache hint)
SELECT * FROM t1 ORDER BY data LIMIT 5;

--echo # Test 3: Prefetch with aggregate scan
SELECT MIN(id), MAX(id), AVG(id) FROM t1;

--echo # Test 4: Prefetch with JOIN (nested loop full scan)
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  ref_id INT
) ENGINE=TidesDB;

INSERT INTO t2 VALUES (1, 100), (2, 200), (3, 300);

SELECT t2.id, t1.data FROM t2 JOIN t1 ON t1.id = t2.ref_id ORDER BY t2.id;

--echo # Test 5: Prefetch with subquery scan
SELECT * FROM t2 WHERE ref_id IN (SELECT id FROM t1 WHERE id <= 3) ORDER BY id;

--echo # Cleanup
DROP TABLE t1, t2;

--echo #
--echo # Prefetch cache tests completed!
--echo #
