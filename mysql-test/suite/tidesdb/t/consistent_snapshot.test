--echo #
--echo # Test START TRANSACTION WITH CONSISTENT SNAPSHOT
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE tidesdb_check;

# Create test table
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  value VARCHAR(100)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'initial');

--echo # Test 1: Basic consistent snapshot
START TRANSACTION WITH CONSISTENT SNAPSHOT;
SELECT * FROM t1;
COMMIT;

--echo # Test 2: Consistent snapshot isolation
--connect (con1, localhost, root,,)
--connection con1
START TRANSACTION WITH CONSISTENT SNAPSHOT;
SELECT * FROM t1 WHERE id = 1;

--connection default
# Update in another connection
UPDATE t1 SET value = 'updated' WHERE id = 1;

--connection con1
# Should still see old value due to snapshot
SELECT * FROM t1 WHERE id = 1;
COMMIT;

# Now should see new value
SELECT * FROM t1 WHERE id = 1;
--disconnect con1

--connection default

--echo # Test 3: Multiple tables with consistent snapshot
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  data VARCHAR(100)
) ENGINE=TidesDB;

INSERT INTO t2 VALUES (1, 'table2_data');

START TRANSACTION WITH CONSISTENT SNAPSHOT;
SELECT * FROM t1;
SELECT * FROM t2;
COMMIT;

--echo # Cleanup
DROP TABLE t1, t2;

--echo #
--echo # Consistent snapshot tests completed!
--echo #
