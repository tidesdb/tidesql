--echo #
--echo # TidesDB Partitioning Tests
--echo #
--echo # Tests for table partitioning support:
--echo # - RANGE partitioning
--echo # - LIST partitioning
--echo # - HASH partitioning
--echo # - Partition pruning
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: RANGE partitioning
CREATE TABLE t_range (
  id INT,
  name VARCHAR(50),
  created_date DATE,
  PRIMARY KEY (id, created_date)
) ENGINE=TidesDB
PARTITION BY RANGE (YEAR(created_date)) (
  PARTITION p2020 VALUES LESS THAN (2021),
  PARTITION p2021 VALUES LESS THAN (2022),
  PARTITION p2022 VALUES LESS THAN (2023),
  PARTITION p2023 VALUES LESS THAN (2024),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);

--vertical_results
SHOW CREATE TABLE t_range;
--horizontal_results

--echo # Insert data into different partitions
INSERT INTO t_range VALUES (1, 'Row 2020', '2020-06-15');
INSERT INTO t_range VALUES (2, 'Row 2021', '2021-03-20');
INSERT INTO t_range VALUES (3, 'Row 2022', '2022-09-10');
INSERT INTO t_range VALUES (4, 'Row 2023', '2023-01-05');
INSERT INTO t_range VALUES (5, 'Row 2024', '2024-07-22');

SELECT * FROM t_range ORDER BY id;

--echo # Test partition pruning
EXPLAIN PARTITIONS SELECT * FROM t_range WHERE created_date = '2022-09-10';

--echo # Test 2: LIST partitioning
CREATE TABLE t_list (
  id INT,
  region VARCHAR(20),
  sales DECIMAL(10,2),
  PRIMARY KEY (id, region)
) ENGINE=TidesDB
PARTITION BY LIST COLUMNS (region) (
  PARTITION p_east VALUES IN ('NY', 'NJ', 'CT'),
  PARTITION p_west VALUES IN ('CA', 'WA', 'OR'),
  PARTITION p_central VALUES IN ('TX', 'IL', 'OH')
);

INSERT INTO t_list VALUES (1, 'NY', 1000.00);
INSERT INTO t_list VALUES (2, 'CA', 2000.00);
INSERT INTO t_list VALUES (3, 'TX', 1500.00);
INSERT INTO t_list VALUES (4, 'WA', 1800.00);
INSERT INTO t_list VALUES (5, 'IL', 1200.00);

SELECT * FROM t_list ORDER BY id;

--echo # Query specific partition
SELECT * FROM t_list PARTITION (p_west) ORDER BY id;

--echo # Test 3: HASH partitioning
CREATE TABLE t_hash (
  id INT PRIMARY KEY,
  data VARCHAR(100)
) ENGINE=TidesDB
PARTITION BY HASH(id)
PARTITIONS 4;

INSERT INTO t_hash VALUES (1, 'Data 1');
INSERT INTO t_hash VALUES (2, 'Data 2');
INSERT INTO t_hash VALUES (3, 'Data 3');
INSERT INTO t_hash VALUES (4, 'Data 4');
INSERT INTO t_hash VALUES (5, 'Data 5');
INSERT INTO t_hash VALUES (6, 'Data 6');
INSERT INTO t_hash VALUES (7, 'Data 7');
INSERT INTO t_hash VALUES (8, 'Data 8');

SELECT * FROM t_hash ORDER BY id;

--echo # Test 4: KEY partitioning
CREATE TABLE t_key (
  id INT,
  name VARCHAR(50),
  PRIMARY KEY (id)
) ENGINE=TidesDB
PARTITION BY KEY(id)
PARTITIONS 3;

INSERT INTO t_key VALUES (1, 'Alice');
INSERT INTO t_key VALUES (2, 'Bob');
INSERT INTO t_key VALUES (3, 'Charlie');
INSERT INTO t_key VALUES (4, 'David');
INSERT INTO t_key VALUES (5, 'Eve');

SELECT * FROM t_key ORDER BY id;

--echo # Test 5: DROP PARTITION
ALTER TABLE t_range DROP PARTITION p2020;
SELECT * FROM t_range ORDER BY id;

--echo # Test 6: TRUNCATE PARTITION
INSERT INTO t_range VALUES (7, 'Another 2023', '2023-12-01');
SELECT COUNT(*) FROM t_range PARTITION (p2023);
ALTER TABLE t_range TRUNCATE PARTITION p2023;
SELECT COUNT(*) FROM t_range PARTITION (p2023);

--echo # Test 7: REORGANIZE PARTITION to add new partitions
ALTER TABLE t_range REORGANIZE PARTITION pmax INTO (
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);

--echo # Insert into new partition
INSERT INTO t_range VALUES (6, 'Row 2025', '2025-05-15');
SELECT * FROM t_range WHERE YEAR(created_date) = 2025;

--vertical_results
SHOW CREATE TABLE t_range;
--horizontal_results

--echo # Cleanup
DROP TABLE t_range;
DROP TABLE t_list;
DROP TABLE t_hash;
DROP TABLE t_key;

--echo #
--echo # Partitioning tests completed!
--echo #
