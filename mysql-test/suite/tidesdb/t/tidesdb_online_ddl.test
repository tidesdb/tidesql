#
# TidesDB Online DDL tests
# Tests INSTANT, INPLACE (add/drop index), and COPY fallback
#

--echo # ---- Setup ----
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  a INT,
  b VARCHAR(100),
  c INT DEFAULT 0
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 10, 'alpha', 100);
INSERT INTO t1 VALUES (2, 20, 'beta', 200);
INSERT INTO t1 VALUES (3, 30, 'gamma', 300);
INSERT INTO t1 VALUES (4, 10, 'delta', 400);
INSERT INTO t1 VALUES (5, 50, 'epsilon', 500);

--echo # ---- INSTANT: change column default ----
ALTER TABLE t1 ALTER COLUMN c SET DEFAULT 999, ALGORITHM=INSTANT;
INSERT INTO t1 (id, a, b) VALUES (6, 60, 'zeta');
SELECT id, c FROM t1 WHERE id = 6;

--echo # ---- INSTANT: rename column ----
ALTER TABLE t1 CHANGE b b_name VARCHAR(100), ALGORITHM=INSTANT;
SELECT id, b_name FROM t1 WHERE id = 1;

--echo # ---- INSTANT: change table option (SYNC_MODE) ----
ALTER TABLE t1 SYNC_MODE='NONE', ALGORITHM=INSTANT;
SHOW CREATE TABLE t1;

--echo # ---- INPLACE: add secondary index ----
ALTER TABLE t1 ADD INDEX idx_a (a), ALGORITHM=INPLACE;
SHOW INDEX FROM t1;

--echo # Verify index is usable
SELECT id, a FROM t1 WHERE a = 10 ORDER BY id;
SELECT id, a FROM t1 WHERE a >= 30 ORDER BY a;

--echo # ---- INPLACE: add another index ----
ALTER TABLE t1 ADD INDEX idx_c (c), ALGORITHM=INPLACE;
SHOW INDEX FROM t1;
EXPLAIN SELECT id, c FROM t1 WHERE c = 200;
SELECT id, c FROM t1 WHERE c = 200;

--echo # ---- INPLACE: drop index ----
ALTER TABLE t1 DROP INDEX idx_a, ALGORITHM=INPLACE;
SHOW INDEX FROM t1;

--echo # Verify remaining index still works
SELECT id, c FROM t1 WHERE c = 300;

--echo # ---- INPLACE: add + drop in one statement ----
ALTER TABLE t1 ADD INDEX idx_a2 (a), DROP INDEX idx_c, ALGORITHM=INPLACE;
SHOW INDEX FROM t1;
EXPLAIN SELECT id, a FROM t1 WHERE a = 20;
SELECT id, a FROM t1 WHERE a = 20;

--echo # ---- COPY fallback: add column ----
ALTER TABLE t1 ADD COLUMN d INT DEFAULT 0;
SELECT id, d FROM t1 WHERE id = 1;

--echo # ---- COPY fallback: drop column ----
ALTER TABLE t1 DROP COLUMN d;
SELECT * FROM t1 WHERE id = 1;

--echo # ---- Verify ALGORITHM=INPLACE rejected for column changes ----
--error ER_ALTER_OPERATION_NOT_SUPPORTED
ALTER TABLE t1 ADD COLUMN e INT, ALGORITHM=INPLACE;

--echo # ---- Cleanup ----
DROP TABLE t1;

--echo # ---- Test with data and hidden PK (no explicit PK) ----
CREATE TABLE t_nopk (
  a INT,
  b VARCHAR(50)
) ENGINE=TidesDB;

INSERT INTO t_nopk VALUES (1, 'one');
INSERT INTO t_nopk VALUES (2, 'two');
INSERT INTO t_nopk VALUES (3, 'three');

--echo # Add index on hidden-PK table
ALTER TABLE t_nopk ADD INDEX idx_a (a), ALGORITHM=INPLACE;
SELECT a, b FROM t_nopk WHERE a = 2;

--echo # Drop it
ALTER TABLE t_nopk DROP INDEX idx_a, ALGORITHM=INPLACE;

DROP TABLE t_nopk;
