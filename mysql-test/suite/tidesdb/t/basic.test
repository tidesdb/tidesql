--echo #
--echo # TidesDB Storage Engine Basic Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create a simple table
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  value INT
) ENGINE=TidesDB;

SHOW CREATE TABLE t1;

--echo # Test 2: Insert data
INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 300);

--echo # Test 3: Select all data
SELECT * FROM t1 ORDER BY id;

--echo # Test 4: Select with WHERE clause
SELECT * FROM t1 WHERE id = 2;
SELECT * FROM t1 WHERE value > 150;

--echo # Test 5: Update data
UPDATE t1 SET value = 250 WHERE id = 2;
SELECT * FROM t1 WHERE id = 2;

--echo # Test 6: Delete data
DELETE FROM t1 WHERE id = 3;
SELECT * FROM t1 ORDER BY id;

--echo # Test 7: Table with auto-increment
CREATE TABLE t2 (
  id INT AUTO_INCREMENT PRIMARY KEY,
  data VARCHAR(50)
) ENGINE=TidesDB;

INSERT INTO t2 (data) VALUES ('row1');
INSERT INTO t2 (data) VALUES ('row2');
INSERT INTO t2 (data) VALUES ('row3');
SELECT * FROM t2 ORDER BY id;

--echo # Test 8: Table without primary key (hidden PK)
CREATE TABLE t3 (
  name VARCHAR(50),
  value INT
) ENGINE=TidesDB;

INSERT INTO t3 VALUES ('test1', 10);
INSERT INTO t3 VALUES ('test2', 20);
SELECT * FROM t3;

--echo # Test 9: Secondary index
CREATE TABLE t4 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(100),
  INDEX idx_name (name)
) ENGINE=TidesDB;

INSERT INTO t4 VALUES (1, 'Alice', 'alice@example.com');
INSERT INTO t4 VALUES (2, 'Bob', 'bob@example.com');
INSERT INTO t4 VALUES (3, 'Alice', 'alice2@example.com');

SELECT * FROM t4 WHERE name = 'Alice' ORDER BY id;

--echo # Test 10: BLOB/TEXT data
CREATE TABLE t5 (
  id INT PRIMARY KEY,
  content TEXT
) ENGINE=TidesDB;

INSERT INTO t5 VALUES (1, REPEAT('Hello World ', 100));
INSERT INTO t5 VALUES (2, 'Short text');
SELECT id, LENGTH(content) FROM t5 ORDER BY id;

--echo # Test 11: Transactions
START TRANSACTION;
INSERT INTO t1 VALUES (10, 'Trans1', 1000);
INSERT INTO t1 VALUES (11, 'Trans2', 1100);
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;
ROLLBACK;
SELECT * FROM t1 WHERE id >= 10 ORDER BY id;

START TRANSACTION;
INSERT INTO t1 VALUES (20, 'Commit1', 2000);
COMMIT;
SELECT * FROM t1 WHERE id = 20;

--echo # Test 12: Savepoints
START TRANSACTION;
INSERT INTO t1 VALUES (30, 'SP1', 3000);
SAVEPOINT sp1;
INSERT INTO t1 VALUES (31, 'SP2', 3100);
ROLLBACK TO SAVEPOINT sp1;
SELECT * FROM t1 WHERE id >= 30 ORDER BY id;
COMMIT;
SELECT * FROM t1 WHERE id >= 30 ORDER BY id;

--echo # Test 13: DELETE all rows
DELETE FROM t3;
SELECT COUNT(*) FROM t3;

--echo # Test 14: TRUNCATE
TRUNCATE TABLE t2;
SELECT COUNT(*) FROM t2;

--echo # Test 15: DROP tables
DROP TABLE t1, t2, t3, t4, t5;

--echo # Test 16: Various data types
CREATE TABLE t6 (
  id INT PRIMARY KEY,
  tiny_col TINYINT,
  small_col SMALLINT,
  big_col BIGINT,
  float_col FLOAT,
  double_col DOUBLE,
  decimal_col DECIMAL(10,2),
  date_col DATE,
  datetime_col DATETIME,
  timestamp_col TIMESTAMP,
  char_col CHAR(10),
  varchar_col VARCHAR(255),
  binary_col BINARY(10),
  varbinary_col VARBINARY(255)
) ENGINE=TidesDB;

INSERT INTO t6 VALUES (
  1, 127, 32767, 9223372036854775807, 
  3.14, 3.14159265359, 12345.67,
  '2024-01-15', '2024-01-15 10:30:00', '2024-01-15 12:00:00',
  'CHAR', 'VARCHAR', 'BINARY', 'VARBINARY'
);

SELECT * FROM t6;

DROP TABLE t6;

--echo #
--echo # All basic tests passed!
--echo #
