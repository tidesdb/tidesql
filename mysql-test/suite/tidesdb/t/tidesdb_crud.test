#
# Test suite for the TIDESDB storage engine.
# Exercises every CRUD capability and edge case.
#

--echo #
--echo # === Setup: install the TIDESDB engine plugin ===
--echo #
--replace_regex /\.dll/.so/

--echo #
--echo # ============================================
--echo # TEST 1: CREATE TABLE / SHOW CREATE TABLE
--echo # ============================================
--echo #

CREATE TABLE t1 (
  id    INT,
  name  VARCHAR(100),
  score DECIMAL(10,2),
  bio   TEXT,
  born  DATE
) ENGINE=TIDESDB;

SHOW CREATE TABLE t1;

--echo #
--echo # ============================================
--echo # TEST 2: INSERT — single row
--echo # ============================================
--echo #

INSERT INTO t1 VALUES (1, 'Alice', 95.50, 'First student', '2000-01-15');

SELECT * FROM t1;
SELECT COUNT(*) AS cnt FROM t1;

--echo #
--echo # ============================================
--echo # TEST 3: INSERT — multiple rows at once
--echo # ============================================
--echo #

INSERT INTO t1 VALUES
  (2, 'Bob',     88.00, 'Second student', '1999-06-20'),
  (3, 'Charlie', 72.25, 'Third student',  '2001-11-03'),
  (4, 'Diana',   91.10, 'Fourth student', '1998-03-30'),
  (5, 'Eve',     67.80, 'Fifth student',  '2002-08-12');

SELECT * FROM t1;
SELECT COUNT(*) AS cnt FROM t1;

--echo #
--echo # ============================================
--echo # TEST 4: SELECT with WHERE (full scan + filter)
--echo # ============================================
--echo #

SELECT * FROM t1 WHERE id = 3;
SELECT * FROM t1 WHERE score > 90;
SELECT * FROM t1 WHERE name LIKE '%li%';
SELECT id, name FROM t1 WHERE id >= 2 AND id <= 4;

--echo #
--echo # ============================================
--echo # TEST 5: SELECT with ORDER BY
--echo #   (exercises position() and rnd_pos())
--echo # ============================================
--echo #

SELECT * FROM t1 ORDER BY score ASC;
SELECT * FROM t1 ORDER BY name DESC;

--echo #
--echo # ============================================
--echo # TEST 6: SELECT aggregate functions
--echo # ============================================
--echo #

SELECT MIN(score) AS min_s, MAX(score) AS max_s, AVG(score) AS avg_s FROM t1;
SELECT SUM(id) AS sum_id FROM t1;

--echo #
--echo # ============================================
--echo # TEST 7: UPDATE — single row via WHERE
--echo # ============================================
--echo #

UPDATE t1 SET score = 99.99 WHERE id = 1;
SELECT * FROM t1 WHERE id = 1;

--echo #
--echo # ============================================
--echo # TEST 8: UPDATE — multiple rows
--echo # ============================================
--echo #

UPDATE t1 SET bio = 'Updated bio' WHERE id IN (2, 4);
SELECT id, bio FROM t1 WHERE id IN (2, 4);

--echo #
--echo # ============================================
--echo # TEST 9: UPDATE — all rows (no WHERE)
--echo # ============================================
--echo #

UPDATE t1 SET name = CONCAT(name, '!');
SELECT id, name FROM t1;

--echo #
--echo # ============================================
--echo # TEST 10: DELETE — single row
--echo # ============================================
--echo #

DELETE FROM t1 WHERE id = 3;
SELECT COUNT(*) AS cnt FROM t1;
SELECT * FROM t1;

--echo #
--echo # ============================================
--echo # TEST 11: DELETE — multiple rows via WHERE
--echo # ============================================
--echo #

DELETE FROM t1 WHERE score < 90;
SELECT COUNT(*) AS cnt FROM t1;
SELECT * FROM t1;

--echo #
--echo # ============================================
--echo # TEST 12: SELECT from empty result set
--echo # ============================================
--echo #

SELECT * FROM t1 WHERE id = 999;

--echo #
--echo # ============================================
--echo # TEST 13: DELETE — all remaining rows via DELETE
--echo # ============================================
--echo #

DELETE FROM t1;
SELECT COUNT(*) AS cnt FROM t1;
SELECT * FROM t1;

--echo #
--echo # ============================================
--echo # TEST 14: Re-insert after full delete
--echo # ============================================
--echo #

INSERT INTO t1 VALUES (10, 'Zara', 100.00, 'Re-inserted', '2005-05-05');
SELECT * FROM t1;

--echo #
--echo # ============================================
--echo # TEST 15: TRUNCATE TABLE (delete_all_rows)
--echo # ============================================
--echo #

INSERT INTO t1 VALUES (11, 'Yuki', 55.00, 'Will be truncated', '2006-06-06');
SELECT COUNT(*) AS cnt FROM t1;

TRUNCATE TABLE t1;
SELECT COUNT(*) AS cnt FROM t1;

--echo #
--echo # ============================================
--echo # TEST 16: NULL handling
--echo # ============================================
--echo #

INSERT INTO t1 VALUES (20, NULL, NULL, NULL, NULL);
INSERT INTO t1 VALUES (21, 'NotNull', 50.00, 'has data', '2010-01-01');
SELECT * FROM t1;
SELECT * FROM t1 WHERE name IS NULL;
SELECT * FROM t1 WHERE name IS NOT NULL;

--echo #
--echo # ============================================
--echo # TEST 17: Multiple data types stress
--echo # ============================================
--echo #

DROP TABLE t1;

CREATE TABLE t2 (
  tiny_col   TINYINT,
  small_col  SMALLINT,
  med_col    MEDIUMINT,
  int_col    INT,
  big_col    BIGINT,
  float_col  FLOAT,
  double_col DOUBLE,
  dec_col    DECIMAL(20,5),
  char_col   CHAR(50),
  vchar_col  VARCHAR(200),
  text_col   TEXT,
  date_col   DATE,
  dt_col     DATETIME,
  ts_col     TIMESTAMP NULL
) ENGINE=TIDESDB;

INSERT INTO t2 VALUES (
  127, 32767, 8388607, 2147483647, 9223372036854775807,
  3.14, 2.718281828, 12345.67890,
  'fixed', 'variable length', 'long text here',
  '2025-12-31', '2025-12-31 23:59:59', '2025-06-15 12:00:00'
);

SELECT * FROM t2;

UPDATE t2 SET char_col = 'UPDATED', int_col = 42;
SELECT char_col, int_col FROM t2;

DELETE FROM t2;
SELECT COUNT(*) AS cnt FROM t2;

DROP TABLE t2;

--echo #
--echo # ============================================
--echo # TEST 18: Multiple independent tables
--echo # ============================================
--echo #

CREATE TABLE ta (a INT, val VARCHAR(20)) ENGINE=TIDESDB;
CREATE TABLE tb (b INT, val VARCHAR(20)) ENGINE=TIDESDB;

INSERT INTO ta VALUES (1, 'ta_one'), (2, 'ta_two');
INSERT INTO tb VALUES (1, 'tb_one'), (3, 'tb_three');

SELECT * FROM ta;
SELECT * FROM tb;

# Cross-table query (nested loop join — both do full scans)
SELECT ta.a, ta.val, tb.b, tb.val FROM ta, tb WHERE ta.a = tb.b;

DROP TABLE ta, tb;

--echo #
--echo # ============================================
--echo # TEST 19: Empty table scan (no rows ever inserted)
--echo # ============================================
--echo #

CREATE TABLE t_empty (x INT) ENGINE=TIDESDB;
SELECT * FROM t_empty;
SELECT COUNT(*) AS cnt FROM t_empty;
DROP TABLE t_empty;

--echo #
--echo # ============================================
--echo # TEST 20: REPLACE (DELETE + INSERT internally)
--echo # ============================================
--echo #

CREATE TABLE t3 (id INT, val VARCHAR(50)) ENGINE=TIDESDB;
INSERT INTO t3 VALUES (1, 'original');
SELECT * FROM t3;
DROP TABLE t3;

--echo #
--echo # ============================================
--echo # TEST 21: INSERT ... SELECT
--echo # ============================================
--echo #

CREATE TABLE t_src (id INT, val VARCHAR(50)) ENGINE=TIDESDB;
CREATE TABLE t_dst (id INT, val VARCHAR(50)) ENGINE=TIDESDB;

INSERT INTO t_src VALUES (1, 'aaa'), (2, 'bbb'), (3, 'ccc');
INSERT INTO t_dst SELECT * FROM t_src;
SELECT * FROM t_dst;

DROP TABLE t_src, t_dst;

--echo #
--echo # ============================================
--echo # TEST 22: UPDATE with expression
--echo # ============================================
--echo #

CREATE TABLE t4 (id INT, counter INT) ENGINE=TIDESDB;
INSERT INTO t4 VALUES (1, 0), (2, 10), (3, 20);
UPDATE t4 SET counter = counter + 5;
SELECT * FROM t4;
UPDATE t4 SET counter = counter * 2 WHERE id > 1;
SELECT * FROM t4;
DROP TABLE t4;

--echo #
--echo # ============================================
--echo # TEST 23: Large-ish batch insert + delete
--echo # ============================================
--echo #

CREATE TABLE t_batch (id INT, padding VARCHAR(100)) ENGINE=TIDESDB;

--disable_query_log
let $i= 1;
while ($i <= 100)
{
  eval INSERT INTO t_batch VALUES ($i, REPEAT('x', 50));
  inc $i;
}
--enable_query_log

SELECT COUNT(*) AS cnt FROM t_batch;

DELETE FROM t_batch WHERE id > 50;
SELECT COUNT(*) AS cnt FROM t_batch;

DELETE FROM t_batch WHERE id <= 25;
SELECT COUNT(*) AS cnt FROM t_batch;

TRUNCATE TABLE t_batch;
SELECT COUNT(*) AS cnt FROM t_batch;

DROP TABLE t_batch;

--echo #
--echo # ============================================
--echo # TEST 24: DROP TABLE (delete_table)
--echo # ============================================
--echo #

CREATE TABLE t_drop (a INT) ENGINE=TIDESDB;
INSERT INTO t_drop VALUES (1), (2), (3);
DROP TABLE t_drop;
--error ER_NO_SUCH_TABLE
SELECT * FROM t_drop;

--echo #
--echo #


--echo # Done.
