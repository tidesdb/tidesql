--echo #
--echo # TidesDB Secondary Index Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Single column index
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  age INT,
  INDEX idx_name (name),
  INDEX idx_age (age)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'Alice', 25);
INSERT INTO t1 VALUES (2, 'Bob', 30);
INSERT INTO t1 VALUES (3, 'Charlie', 25);
INSERT INTO t1 VALUES (4, 'David', 35);
INSERT INTO t1 VALUES (5, 'Alice', 28);

--echo # Test 2: Index lookup
SELECT * FROM t1 WHERE name = 'Alice' ORDER BY id;
SELECT * FROM t1 WHERE age = 25 ORDER BY id;

--echo # Test 3: Index range scan
SELECT * FROM t1 WHERE age >= 28 ORDER BY age;
SELECT * FROM t1 WHERE name >= 'C' ORDER BY name;

--echo # Test 4: Composite index
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  first_name VARCHAR(50),
  last_name VARCHAR(50),
  city VARCHAR(50),
  INDEX idx_name (first_name, last_name),
  INDEX idx_city (city)
) ENGINE=TidesDB;

INSERT INTO t2 VALUES (1, 'John', 'Doe', 'New York');
INSERT INTO t2 VALUES (2, 'Jane', 'Doe', 'Los Angeles');
INSERT INTO t2 VALUES (3, 'John', 'Smith', 'Chicago');
INSERT INTO t2 VALUES (4, 'Jane', 'Smith', 'New York');
INSERT INTO t2 VALUES (5, 'Bob', 'Johnson', 'Chicago');

--echo # Test 5: Composite index lookup
SELECT * FROM t2 WHERE first_name = 'John' ORDER BY id;
SELECT * FROM t2 WHERE first_name = 'John' AND last_name = 'Doe';
SELECT * FROM t2 WHERE first_name = 'Jane' AND last_name = 'Smith';

--echo # Test 6: Index with NULL values
CREATE TABLE t3 (
  id INT PRIMARY KEY,
  nullable_col VARCHAR(50),
  INDEX idx_nullable (nullable_col)
) ENGINE=TidesDB;

INSERT INTO t3 VALUES (1, 'value1');
INSERT INTO t3 VALUES (2, NULL);
INSERT INTO t3 VALUES (3, 'value2');
INSERT INTO t3 VALUES (4, NULL);
INSERT INTO t3 VALUES (5, 'value1');

SELECT * FROM t3 WHERE nullable_col IS NULL ORDER BY id;
SELECT * FROM t3 WHERE nullable_col = 'value1' ORDER BY id;

--echo # Test 7: Update indexed column
UPDATE t1 SET name = 'Alicia' WHERE id = 1;
SELECT * FROM t1 WHERE name = 'Alice' ORDER BY id;
SELECT * FROM t1 WHERE name = 'Alicia';

--echo # Test 8: Delete with index
DELETE FROM t1 WHERE name = 'Bob';
SELECT * FROM t1 ORDER BY id;

--echo # Test 9: Index on different data types
CREATE TABLE t4 (
  id INT PRIMARY KEY,
  int_col INT,
  bigint_col BIGINT,
  date_col DATE,
  INDEX idx_int (int_col),
  INDEX idx_bigint (bigint_col),
  INDEX idx_date (date_col)
) ENGINE=TidesDB;

INSERT INTO t4 VALUES (1, 100, 1000000000000, '2024-01-15');
INSERT INTO t4 VALUES (2, 200, 2000000000000, '2024-02-20');
INSERT INTO t4 VALUES (3, 100, 3000000000000, '2024-01-15');

SELECT * FROM t4 WHERE int_col = 100 ORDER BY id;
SELECT * FROM t4 WHERE date_col = '2024-01-15' ORDER BY id;

--echo # Test 10: EXPLAIN shows index usage
EXPLAIN SELECT * FROM t1 WHERE name = 'Charlie';
EXPLAIN SELECT * FROM t2 WHERE first_name = 'John' AND last_name = 'Doe';

--echo # Cleanup
DROP TABLE t1, t2, t3, t4;

--echo #
--echo # Secondary index tests completed!
--echo #
