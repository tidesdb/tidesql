--echo #
--echo # TidesDB spatial geometry types tests
--echo #

# Check if TidesDB is available
--disable_query_log
--disable_result_log
CREATE TABLE t_check (id INT) ENGINE=TidesDB;
DROP TABLE t_check;
--enable_result_log
--enable_query_log

--echo #
--echo # Test 1: POINT geometry with spatial index
--echo #

CREATE TABLE points (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  location POINT NOT NULL,
  SPATIAL INDEX (location)
) ENGINE=TidesDB;

INSERT INTO points VALUES 
  (1, 'New York', ST_GeomFromText('POINT(-74.006 40.7128)')),
  (2, 'Los Angeles', ST_GeomFromText('POINT(-118.2437 34.0522)')),
  (3, 'Chicago', ST_GeomFromText('POINT(-87.6298 41.8781)')),
  (4, 'Houston', ST_GeomFromText('POINT(-95.3698 29.7604)')),
  (5, 'Phoenix', ST_GeomFromText('POINT(-112.0740 33.4484)'));

SELECT id, name, ST_AsText(location) FROM points ORDER BY id;

--echo # Query points
SELECT id, name FROM points WHERE ST_X(location) < -100 ORDER BY id;

DROP TABLE points;

--echo #
--echo # Test 2: LINESTRING geometry with spatial index
--echo #

CREATE TABLE routes (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  path LINESTRING NOT NULL,
  SPATIAL INDEX (path)
) ENGINE=TidesDB;

INSERT INTO routes VALUES 
  (1, 'Route A', ST_GeomFromText('LINESTRING(0 0, 10 10, 20 0)')),
  (2, 'Route B', ST_GeomFromText('LINESTRING(5 5, 15 15, 25 5)')),
  (3, 'Route C', ST_GeomFromText('LINESTRING(-10 -10, 0 0, 10 -10)'));

SELECT id, name, ST_AsText(path) FROM routes ORDER BY id;

DROP TABLE routes;

--echo #
--echo # Test 3: POLYGON geometry with spatial index
--echo #

CREATE TABLE regions (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  boundary POLYGON NOT NULL,
  SPATIAL INDEX (boundary)
) ENGINE=TidesDB;

INSERT INTO regions VALUES 
  (1, 'Square', ST_GeomFromText('POLYGON((0 0, 10 0, 10 10, 0 10, 0 0))')),
  (2, 'Triangle', ST_GeomFromText('POLYGON((20 0, 30 10, 20 10, 20 0))')),
  (3, 'Rectangle', ST_GeomFromText('POLYGON((40 0, 60 0, 60 20, 40 20, 40 0))'));

SELECT id, name, ST_AsText(boundary) FROM regions ORDER BY id;

DROP TABLE regions;

--echo #
--echo # Test 4: Mixed geometry operations
--echo #

CREATE TABLE geo_data (
  id INT PRIMARY KEY,
  geom GEOMETRY NOT NULL,
  SPATIAL INDEX (geom)
) ENGINE=TidesDB;

INSERT INTO geo_data VALUES 
  (1, ST_GeomFromText('POINT(5 5)')),
  (2, ST_GeomFromText('LINESTRING(0 0, 10 10)')),
  (3, ST_GeomFromText('POLYGON((0 0, 10 0, 10 10, 0 10, 0 0))'));

SELECT id, ST_GeometryType(geom), ST_AsText(geom) FROM geo_data ORDER BY id;

DROP TABLE geo_data;

--echo #
--echo # Test 5: Spatial index with updates
--echo #

CREATE TABLE moving_points (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  pos POINT NOT NULL,
  SPATIAL INDEX (pos)
) ENGINE=TidesDB;

INSERT INTO moving_points VALUES 
  (1, 'Object A', ST_GeomFromText('POINT(0 0)')),
  (2, 'Object B', ST_GeomFromText('POINT(10 10)'));

--echo # Before update
SELECT id, name, ST_AsText(pos) FROM moving_points ORDER BY id;

--echo # Move Object A
UPDATE moving_points SET pos = ST_GeomFromText('POINT(50 50)') WHERE id = 1;

--echo # After update
SELECT id, name, ST_AsText(pos) FROM moving_points ORDER BY id;

--echo # Delete and verify
DELETE FROM moving_points WHERE id = 2;
SELECT id, name, ST_AsText(pos) FROM moving_points ORDER BY id;

DROP TABLE moving_points;

--echo #
--echo # Test 6: Multiple spatial indexes
--echo #

CREATE TABLE dual_spatial (
  id INT PRIMARY KEY,
  start_point POINT NOT NULL,
  end_point POINT NOT NULL,
  SPATIAL INDEX (start_point),
  SPATIAL INDEX (end_point)
) ENGINE=TidesDB;

INSERT INTO dual_spatial VALUES 
  (1, ST_GeomFromText('POINT(0 0)'), ST_GeomFromText('POINT(100 100)')),
  (2, ST_GeomFromText('POINT(10 10)'), ST_GeomFromText('POINT(90 90)'));

SELECT id, ST_AsText(start_point), ST_AsText(end_point) FROM dual_spatial ORDER BY id;

DROP TABLE dual_spatial;

--echo #
--echo # Spatial geometry tests completed!
--echo #
