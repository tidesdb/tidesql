--echo #
--echo # TidesDB Disable/Enable Indexes for Bulk Load
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Disable keys, bulk insert, enable keys
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  value INT,
  INDEX idx_name (name),
  INDEX idx_value (value)
) ENGINE=TidesDB;

--echo # Disable secondary indexes
ALTER TABLE t1 DISABLE KEYS;

--echo # Bulk insert with indexes disabled
--disable_query_log
let $i = 1;
while ($i <= 200)
{
  eval INSERT INTO t1 VALUES ($i, CONCAT('name_', $i), $i * 10);
  inc $i;
}
--enable_query_log

SELECT COUNT(*) FROM t1;

--echo # Re-enable and rebuild indexes
ALTER TABLE t1 ENABLE KEYS;

--echo # Verify secondary index works after rebuild
SELECT COUNT(*) FROM t1 WHERE name = 'name_100';
SELECT COUNT(*) FROM t1 WHERE value = 500;
SELECT * FROM t1 WHERE name = 'name_1' ORDER BY id;

--echo # Test 2: Verify index scan works after rebuild
--replace_column 1 # 2 # 3 # 4 # 5 # 6 # 7 # 8 # 9 # 10 #
EXPLAIN SELECT * FROM t1 WHERE name = 'name_50';

--echo # Test 3: Disable/enable on table with no secondary indexes (no-op)
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  data VARCHAR(255)
) ENGINE=TidesDB;

ALTER TABLE t2 DISABLE KEYS;
INSERT INTO t2 VALUES (1, 'test');
ALTER TABLE t2 ENABLE KEYS;
SELECT * FROM t2;

--echo # Test 4: Multiple disable/enable cycles
CREATE TABLE t3 (
  id INT PRIMARY KEY,
  val INT,
  INDEX idx_val (val)
) ENGINE=TidesDB;

ALTER TABLE t3 DISABLE KEYS;
INSERT INTO t3 VALUES (1, 10), (2, 20), (3, 30);
ALTER TABLE t3 ENABLE KEYS;

SELECT * FROM t3 WHERE val = 20;

ALTER TABLE t3 DISABLE KEYS;
INSERT INTO t3 VALUES (4, 40), (5, 50);
ALTER TABLE t3 ENABLE KEYS;

SELECT COUNT(*) FROM t3;
SELECT * FROM t3 WHERE val >= 30 ORDER BY id;

--echo # Cleanup
DROP TABLE t1, t2, t3;

--echo #
--echo # Disable/enable indexes tests completed!
--echo #
