--echo #
--echo # TidesDB Auto-Increment Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Basic auto-increment
CREATE TABLE t1 (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100)
) ENGINE=TidesDB;

INSERT INTO t1 (name) VALUES ('row1');
INSERT INTO t1 (name) VALUES ('row2');
INSERT INTO t1 (name) VALUES ('row3');
SELECT * FROM t1 ORDER BY id;

--echo # Test 2: LAST_INSERT_ID()
INSERT INTO t1 (name) VALUES ('row4');
SELECT LAST_INSERT_ID();

--echo # Test 3: Explicit ID with auto-increment
INSERT INTO t1 (id, name) VALUES (100, 'explicit100');
INSERT INTO t1 (name) VALUES ('after100');
SELECT * FROM t1 ORDER BY id;

--echo # Test 4: Auto-increment after DELETE
DELETE FROM t1 WHERE id = 100;
INSERT INTO t1 (name) VALUES ('afterDelete');
SELECT * FROM t1 ORDER BY id;

--echo # Test 5: Auto-increment with TRUNCATE (bug fix test)
TRUNCATE TABLE t1;
INSERT INTO t1 (name) VALUES ('afterTruncate1');
INSERT INTO t1 (name) VALUES ('afterTruncate2');
SELECT * FROM t1 ORDER BY id;

--echo # Test 6: BIGINT auto-increment
CREATE TABLE t2 (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  data VARCHAR(100)
) ENGINE=TidesDB;

INSERT INTO t2 (data) VALUES ('big1'), ('big2'), ('big3');
SELECT * FROM t2 ORDER BY id;

--echo # Test 7: Multi-row INSERT with auto-increment
DROP TABLE t1;
CREATE TABLE t1 (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(100)
) ENGINE=TidesDB;

INSERT INTO t1 (name) VALUES ('multi1'), ('multi2'), ('multi3');
SELECT * FROM t1 ORDER BY id;

--echo # Cleanup
DROP TABLE t1, t2;

--echo #
--echo # Auto-increment tests completed!
--echo #
