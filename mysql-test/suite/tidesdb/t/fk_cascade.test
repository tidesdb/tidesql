--echo #
--echo # TidesDB Foreign Key Definition Tests
--echo #
--echo # Tests for FK constraint definitions with various actions.
--echo # Note: TidesDB stores FK definitions in MariaDB's data dictionary.
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create tables with FK ON DELETE CASCADE definition
CREATE TABLE parent1 (
  id INT PRIMARY KEY,
  name VARCHAR(50)
) ENGINE=TidesDB;

CREATE TABLE child1 (
  id INT PRIMARY KEY,
  parent_id INT,
  value VARCHAR(50),
  FOREIGN KEY (parent_id) REFERENCES parent1(id) ON DELETE CASCADE
) ENGINE=TidesDB;

--echo # Verify FK definition is stored
SHOW CREATE TABLE child1;

--echo # Insert data
INSERT INTO parent1 VALUES (1, 'Parent 1');
INSERT INTO parent1 VALUES (2, 'Parent 2');
INSERT INTO child1 VALUES (1, 1, 'Child 1');
INSERT INTO child1 VALUES (2, 1, 'Child 2');
INSERT INTO child1 VALUES (3, 2, 'Child 3');

SELECT * FROM parent1 ORDER BY id;
SELECT * FROM child1 ORDER BY id;

--echo # Test 2: Create tables with FK ON DELETE SET NULL definition
CREATE TABLE parent2 (
  id INT PRIMARY KEY,
  name VARCHAR(50)
) ENGINE=TidesDB;

CREATE TABLE child2 (
  id INT PRIMARY KEY,
  parent_id INT,
  value VARCHAR(50),
  FOREIGN KEY (parent_id) REFERENCES parent2(id) ON DELETE SET NULL
) ENGINE=TidesDB;

--echo # Verify FK definition is stored
SHOW CREATE TABLE child2;

INSERT INTO parent2 VALUES (1, 'Parent 1');
INSERT INTO child2 VALUES (1, 1, 'Child 1');

SELECT * FROM child2 ORDER BY id;

--echo # Test 3: Create tables with FK ON UPDATE CASCADE definition
CREATE TABLE parent3 (
  id INT PRIMARY KEY,
  name VARCHAR(50)
) ENGINE=TidesDB;

CREATE TABLE child3 (
  id INT PRIMARY KEY,
  parent_id INT,
  value VARCHAR(50),
  FOREIGN KEY (parent_id) REFERENCES parent3(id) ON UPDATE CASCADE
) ENGINE=TidesDB;

--echo # Verify FK definition is stored
SHOW CREATE TABLE child3;

--echo # Test 4: Composite FK
CREATE TABLE parent4 (
  id1 INT,
  id2 INT,
  name VARCHAR(50),
  PRIMARY KEY (id1, id2)
) ENGINE=TidesDB;

CREATE TABLE child4 (
  id INT PRIMARY KEY,
  p_id1 INT,
  p_id2 INT,
  value VARCHAR(50),
  FOREIGN KEY (p_id1, p_id2) REFERENCES parent4(id1, id2)
) ENGINE=TidesDB;

--echo # Verify composite FK definition
SHOW CREATE TABLE child4;

INSERT INTO parent4 VALUES (1, 1, 'Parent 1-1');
INSERT INTO parent4 VALUES (1, 2, 'Parent 1-2');
INSERT INTO child4 VALUES (1, 1, 1, 'Child referencing 1-1');
INSERT INTO child4 VALUES (2, 1, 2, 'Child referencing 1-2');

SELECT * FROM child4 ORDER BY id;

--echo # Test 5: Self-referencing FK (employee -> manager)
CREATE TABLE employees (
  id INT PRIMARY KEY,
  name VARCHAR(50),
  manager_id INT,
  FOREIGN KEY (manager_id) REFERENCES employees(id) ON DELETE SET NULL
) ENGINE=TidesDB;

--echo # Verify self-referencing FK definition
SHOW CREATE TABLE employees;

--echo # Insert hierarchical data
INSERT INTO employees VALUES (1, 'CEO', NULL);
INSERT INTO employees VALUES (2, 'VP', 1);
INSERT INTO employees VALUES (3, 'Manager', 2);
INSERT INTO employees VALUES (4, 'Employee', 3);

SELECT * FROM employees ORDER BY id;

--echo # Test 6: ALTER TABLE on table with self-referencing FK
--echo # This tests get_parent_foreign_key_list() functionality
ALTER TABLE employees ADD COLUMN department VARCHAR(50);
SHOW CREATE TABLE employees;

SELECT * FROM employees ORDER BY id;

--echo # Cleanup
DROP TABLE employees;
DROP TABLE child4;
DROP TABLE parent4;
DROP TABLE child3;
DROP TABLE parent3;
DROP TABLE child2;
DROP TABLE parent2;
DROP TABLE child1;
DROP TABLE parent1;

--echo #
--echo # FK definition tests completed!
--echo #
