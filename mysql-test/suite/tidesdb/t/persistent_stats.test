--echo #
--echo # TidesDB Persistent Statistics Tests
--echo #
--echo # Tests that ANALYZE TABLE persists statistics and they survive
--echo # table close/reopen cycles.
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create and populate table
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  value INT,
  INDEX idx_name (name)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 300);
INSERT INTO t1 VALUES (4, 'Diana', 400);
INSERT INTO t1 VALUES (5, 'Eve', 500);

--echo # Test 2: ANALYZE TABLE persists statistics
--replace_column 2 X 3 X 4 X
ANALYZE TABLE t1;

--echo # Test 3: Verify row count is accurate after ANALYZE
SELECT COUNT(*) AS actual_count FROM t1;

--echo # Test 4: FLUSH TABLES forces table close, then reopen
FLUSH TABLES t1;

--echo # Test 5: After reopen, stats should still be available
--replace_column 5 X 6 X 7 X 8 X 9 X 10 X 11 X 12 X 13 X 14 X 15 X 16 X 17 X 18 X 19 X 20 X 21 X
SHOW TABLE STATUS LIKE 't1';

--echo # Test 6: Verify data is intact after flush
SELECT * FROM t1 ORDER BY id;

--echo # Test 7: Insert more data and re-analyze
INSERT INTO t1 VALUES (6, 'Frank', 600);
INSERT INTO t1 VALUES (7, 'Grace', 700);

--replace_column 2 X 3 X 4 X
ANALYZE TABLE t1;

SELECT COUNT(*) AS updated_count FROM t1;

--echo # Cleanup
DROP TABLE t1;

--echo #
--echo # Persistent statistics tests completed!
--echo #
