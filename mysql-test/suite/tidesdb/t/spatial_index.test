--echo #
--echo # TidesDB Spatial Index Tests (Z-order encoding)
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE tidesdb_check;

--echo # Test 1: Create table with SPATIAL INDEX
CREATE TABLE locations (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  coords POINT NOT NULL,
  SPATIAL INDEX (coords)
) ENGINE=TidesDB;

--echo # Test 2: Insert spatial data
INSERT INTO locations VALUES (1, 'New York', ST_GeomFromText('POINT(-74.006 40.7128)'));
INSERT INTO locations VALUES (2, 'Los Angeles', ST_GeomFromText('POINT(-118.2437 34.0522)'));
INSERT INTO locations VALUES (3, 'Chicago', ST_GeomFromText('POINT(-87.6298 41.8781)'));
INSERT INTO locations VALUES (4, 'Houston', ST_GeomFromText('POINT(-95.3698 29.7604)'));
INSERT INTO locations VALUES (5, 'Phoenix', ST_GeomFromText('POINT(-112.074 33.4484)'));

--echo # Test 3: Verify data was inserted
SELECT id, name, ST_AsText(coords) FROM locations ORDER BY id;

--echo # Test 4: Spatial query - find points
SELECT id, name FROM locations WHERE ST_X(coords) < -100 ORDER BY id;

--echo # Test 5: Update spatial data
UPDATE locations SET coords = ST_GeomFromText('POINT(-74.0060 40.7128)') WHERE id = 1;
SELECT id, name, ST_AsText(coords) FROM locations WHERE id = 1;

--echo # Test 6: Delete spatial data
DELETE FROM locations WHERE id = 5;
SELECT COUNT(*) FROM locations;

--echo # Test 7: Multiple spatial indexes
CREATE TABLE geo_data (
  id INT PRIMARY KEY,
  location POINT NOT NULL,
  boundary POINT NOT NULL,
  SPATIAL INDEX idx_loc (location),
  SPATIAL INDEX idx_bound (boundary)
) ENGINE=TidesDB;

INSERT INTO geo_data VALUES (1, ST_GeomFromText('POINT(0 0)'), ST_GeomFromText('POINT(10 10)'));
INSERT INTO geo_data VALUES (2, ST_GeomFromText('POINT(5 5)'), ST_GeomFromText('POINT(15 15)'));

SELECT id, ST_AsText(location), ST_AsText(boundary) FROM geo_data ORDER BY id;

--echo # Cleanup
DROP TABLE geo_data;
DROP TABLE locations;

--echo #
--echo # Spatial index tests completed!
--echo #
