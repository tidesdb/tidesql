--echo #
--echo # TidesDB Fulltext Search Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create table with FULLTEXT index
CREATE TABLE articles (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(200),
  body TEXT,
  FULLTEXT INDEX ft_title (title),
  FULLTEXT INDEX ft_body (body),
  FULLTEXT INDEX ft_all (title, body)
) ENGINE=TidesDB;

SHOW CREATE TABLE articles;

--echo # Test 2: Insert test data
INSERT INTO articles (title, body) VALUES 
  ('MySQL Tutorial', 'DBMS stands for DataBase Management System'),
  ('How To Use MySQL Well', 'After you went through a tutorial you should practice'),
  ('Optimizing MySQL', 'In this tutorial we will show how to optimize queries'),
  ('1001 MySQL Tricks', 'How to use MySQL to its full potential'),
  ('MySQL vs PostgreSQL', 'Comparing two popular database systems'),
  ('Database Design Basics', 'Learn the fundamentals of database design'),
  ('Advanced SQL Queries', 'Complex queries for data analysis'),
  ('NoSQL Introduction', 'Understanding non-relational databases');

--echo # Test 3: Natural language search on title
SELECT id, title FROM articles 
WHERE MATCH(title) AGAINST('MySQL');

--echo # Test 4: Natural language search on body
SELECT id, title FROM articles 
WHERE MATCH(body) AGAINST('tutorial');

--echo # Test 5: Search across multiple columns
SELECT id, title FROM articles 
WHERE MATCH(title, body) AGAINST('database');

--echo # Test 6: Boolean mode search
SELECT id, title FROM articles 
WHERE MATCH(title) AGAINST('+MySQL -PostgreSQL' IN BOOLEAN MODE);

--echo # Test 7: Search with relevance score
SELECT id, title, MATCH(title, body) AGAINST('MySQL tutorial') AS relevance
FROM articles 
WHERE MATCH(title, body) AGAINST('MySQL tutorial')
ORDER BY relevance DESC;

--echo # Test 8: Update and verify FT index updates
UPDATE articles SET title = 'MariaDB Tutorial' WHERE id = 1;
SELECT id, title FROM articles WHERE MATCH(title) AGAINST('MariaDB');
SELECT id, title FROM articles WHERE MATCH(title) AGAINST('MySQL');

--echo # Test 9: Delete and verify FT index updates
DELETE FROM articles WHERE id = 2;
SELECT id, title FROM articles WHERE MATCH(body) AGAINST('practice');

--echo # Test 10: Empty search result
SELECT id, title FROM articles WHERE MATCH(title) AGAINST('nonexistent');

--echo # Cleanup
DROP TABLE articles;

--echo #
--echo # Fulltext tests completed!
--echo #
