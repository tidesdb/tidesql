--echo #
--echo # TidesDB check_if_incompatible_data Tests
--echo #
--echo # Tests that metadata-only ALTERs avoid unnecessary table rebuilds.
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create test table
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100) DEFAULT 'unknown',
  value INT
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 300);

--echo # Test 2: ALTER TABLE COMMENT (metadata only, should not rebuild)
ALTER TABLE t1 COMMENT='Test table with comment';
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY id;

--echo # Test 3: ALTER TABLE change default value (metadata only)
ALTER TABLE t1 ALTER COLUMN name SET DEFAULT 'no_name';
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY id;

--echo # Test 4: ALTER TABLE rename column (instant)
ALTER TABLE t1 RENAME COLUMN value TO amount;
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY id;

--echo # Test 5: ALTER TABLE rename table (instant)
ALTER TABLE t1 RENAME TO t1_renamed;
SELECT * FROM t1_renamed ORDER BY id;

--echo # Test 6: Rename back
ALTER TABLE t1_renamed RENAME TO t1;

--echo # Test 7: ALTER TABLE ADD INDEX (inplace, not copy)
ALTER TABLE t1 ADD INDEX idx_name (name);
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY id;

--echo # Test 8: ALTER TABLE DROP INDEX (inplace)
ALTER TABLE t1 DROP INDEX idx_name;
SHOW CREATE TABLE t1;

--echo # Test 9: ALTER TABLE ADD COLUMN (requires copy -- stored column)
ALTER TABLE t1 ADD COLUMN extra VARCHAR(50);
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY id;

--echo # Test 10: Data integrity after all ALTERs
SELECT COUNT(*) FROM t1;

--echo # Cleanup
DROP TABLE t1;

--echo #
--echo # Compatible data tests completed!
--echo #
