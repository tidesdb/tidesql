--echo #
--echo # TidesDB BLOB/TEXT with secondary index test
--echo # Tests large values with vlog indirection + index maintenance
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: TEXT column with secondary index on other columns
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  title VARCHAR(100),
  body TEXT,
  KEY idx_title (title)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'first', REPEAT('a', 10000));
INSERT INTO t1 VALUES (2, 'second', REPEAT('b', 50000));
INSERT INTO t1 VALUES (3, 'first', REPEAT('c', 60000));

--echo # Index scan should work with large TEXT values
SELECT id, title, LENGTH(body) FROM t1 WHERE title = 'first' ORDER BY id;

--echo # Test 2: Update large value
UPDATE t1 SET body = REPEAT('x', 60000) WHERE id = 2;
SELECT id, LENGTH(body) FROM t1 WHERE id = 2;

--echo # Test 3: Delete row with large value
DELETE FROM t1 WHERE id = 1;
SELECT id, title FROM t1 ORDER BY id;

--echo # Test 4: BLOB column
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  data BLOB,
  tag VARCHAR(50),
  KEY idx_tag (tag)
) ENGINE=TidesDB;

INSERT INTO t2 VALUES (1, REPEAT(x'DE', 5000), 'binary1');
INSERT INTO t2 VALUES (2, REPEAT(x'CA', 10000), 'binary2');
INSERT INTO t2 VALUES (3, REPEAT(x'DE', 5000), 'binary1');

SELECT id, LENGTH(data), tag FROM t2 WHERE tag = 'binary1' ORDER BY id;

--echo # Test 5: Multiple TEXT/BLOB columns
CREATE TABLE t3 (
  id INT PRIMARY KEY,
  col1 TEXT,
  col2 TEXT,
  col3 BLOB,
  name VARCHAR(50),
  KEY idx_name (name)
) ENGINE=TidesDB;

INSERT INTO t3 VALUES (1, REPEAT('a', 1000), REPEAT('b', 5000), REPEAT(x'FF', 2000), 'row1');
INSERT INTO t3 VALUES (2, REPEAT('c', 2000), REPEAT('d', 10000), REPEAT(x'01', 3000), 'row2');

SELECT id, LENGTH(col1), LENGTH(col2), LENGTH(col3), name FROM t3 ORDER BY id;

--echo # Test 6: Bulk insert with large values
CREATE TABLE t4 (
  id INT PRIMARY KEY,
  val TEXT
) ENGINE=TidesDB;

--disable_query_log
let $i = 1;
while ($i <= 100)
{
  eval INSERT INTO t4 VALUES ($i, REPEAT('x', 5000 + $i * 100));
  inc $i;
}
--enable_query_log

SELECT COUNT(*) FROM t4;
SELECT id, LENGTH(val) FROM t4 WHERE id IN (1, 50, 100) ORDER BY id;

--echo # Cleanup
DROP TABLE t4;
DROP TABLE t3;
DROP TABLE t2;
DROP TABLE t1;
