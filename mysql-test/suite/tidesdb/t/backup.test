--echo #
--echo # TidesDB Backup and Data Integrity Tests
--echo #
--echo # Note: TidesDB backup API (tidesdb_backup) is available for programmatic use.
--echo # This test verifies data integrity and persistence which are prerequisites for backup.
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Create test table with data
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  value INT
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'Alice', 100);
INSERT INTO t1 VALUES (2, 'Bob', 200);
INSERT INTO t1 VALUES (3, 'Charlie', 300);
INSERT INTO t1 VALUES (4, 'Diana', 400);
INSERT INTO t1 VALUES (5, 'Eve', 500);

SELECT * FROM t1 ORDER BY id;

--echo # Test 2: Create secondary index table
CREATE TABLE t2 (
  id INT AUTO_INCREMENT PRIMARY KEY,
  email VARCHAR(100),
  score INT,
  INDEX idx_score (score)
) ENGINE=TidesDB;

INSERT INTO t2 (email, score) VALUES ('user1@test.com', 85);
INSERT INTO t2 (email, score) VALUES ('user2@test.com', 92);
INSERT INTO t2 (email, score) VALUES ('user3@test.com', 78);

SELECT * FROM t2 ORDER BY id;

--echo # Test 3: Flush tables to ensure data is persisted (prerequisite for backup)
FLUSH TABLES t1, t2;

--echo # Test 4: Verify data is still accessible after flush
SELECT COUNT(*) FROM t1;
SELECT COUNT(*) FROM t2;

--echo # Test 5: ANALYZE TABLE (updates statistics without triggering compaction)
ANALYZE TABLE t1;
ANALYZE TABLE t2;

--echo # Test 6: Insert more data
INSERT INTO t1 VALUES (6, 'Frank', 600);
INSERT INTO t2 (email, score) VALUES ('user4@test.com', 88);

SELECT * FROM t1 ORDER BY id;
SELECT * FROM t2 ORDER BY id;

--echo # Test 7: ANALYZE TABLE (updates statistics)
ANALYZE TABLE t1;
ANALYZE TABLE t2;

--echo # Test 8: CHECK TABLE (verifies data integrity)
CHECK TABLE t1;
CHECK TABLE t2;

--echo # Test 9: Update and delete operations
UPDATE t1 SET value = 150 WHERE id = 1;
DELETE FROM t1 WHERE id = 3;

SELECT * FROM t1 ORDER BY id;

--echo # Test 10: Final flush and check
FLUSH TABLES;
CHECK TABLE t1;

--echo # Cleanup
DROP TABLE t1, t2;

--echo #
--echo # Backup prerequisite tests completed!
--echo # TidesDB backup API (tidesdb_backup) can be called programmatically.
--echo #
