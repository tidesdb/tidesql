--echo #
--echo # TidesDB DDL Tests
--echo #
--echo # Tests for ALTER TABLE operations:
--echo # - ADD/DROP COLUMN
--echo # - ADD/DROP INDEX
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Basic table creation with index
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  email VARCHAR(100),
  INDEX idx_name (name)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'Alice', 'alice@example.com');
INSERT INTO t1 VALUES (2, 'Bob', 'bob@example.com');
INSERT INTO t1 VALUES (3, 'Charlie', 'charlie@example.com');

SELECT * FROM t1 ORDER BY id;

--echo # Test 2: ADD COLUMN
ALTER TABLE t1 ADD COLUMN age INT;
SHOW CREATE TABLE t1;

--echo # Verify existing data is preserved
SELECT * FROM t1 ORDER BY id;

--echo # Update with new column
UPDATE t1 SET age = 25 WHERE id = 1;
UPDATE t1 SET age = 30 WHERE id = 2;
UPDATE t1 SET age = 35 WHERE id = 3;
SELECT * FROM t1 ORDER BY id;

--echo # Test 3: ADD COLUMN with DEFAULT
ALTER TABLE t1 ADD COLUMN status VARCHAR(20) DEFAULT 'active';
SELECT * FROM t1 ORDER BY id;

--echo # Test 4: DROP COLUMN
ALTER TABLE t1 DROP COLUMN status;
SHOW CREATE TABLE t1;
SELECT * FROM t1 ORDER BY id;

--echo # Test 5: Verify index still works
SELECT * FROM t1 WHERE name = 'Alice';

--echo # Test 6: Insert more data
INSERT INTO t1 VALUES (4, 'David', 'david@example.com', 40);
INSERT INTO t1 VALUES (5, 'Eve', 'eve@example.com', 28);
SELECT * FROM t1 ORDER BY id;

--echo # Cleanup
DROP TABLE t1;

--echo #
--echo # DDL tests completed!
--echo #
