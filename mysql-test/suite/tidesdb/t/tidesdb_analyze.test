--echo #
--echo # ANALYZE TABLE for TidesDB -- verifies CF stats output
--echo #

CREATE TABLE t1 (
  id INT PRIMARY KEY,
  val VARCHAR(40),
  KEY idx_val (val)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES (1, 'alpha'), (2, 'bravo'), (3, 'charlie'),
                      (4, 'delta'), (5, 'echo'),  (6, 'foxtrot');

--echo # ANALYZE TABLE should return status OK and emit CF stats as notes.
--echo # Mask volatile numeric values (memtable size, avg sizes, etc.)
--replace_regex /total_keys=[0-9]+/total_keys=N/ /data_size=[0-9]+/data_size=N/ /memtable=[0-9]+/memtable=N/ /read_amp=[0-9.]+/read_amp=N/ /cache_hit=[0-9.]+/cache_hit=N/ /avg_key=[0-9.]+/avg_key=N/ /avg_value=[0-9.]+/avg_value=N/ /sstables=[0-9]+/sstables=N/ /size=[0-9]+/size=N/ /keys=[0-9]+/keys=N/
ANALYZE TABLE t1;

--echo # ANALYZE a table without secondary indexes
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  data VARCHAR(200)
) ENGINE=TidesDB;

INSERT INTO t2 VALUES (1, REPEAT('x', 100)), (2, REPEAT('y', 100));

--replace_regex /total_keys=[0-9]+/total_keys=N/ /data_size=[0-9]+/data_size=N/ /memtable=[0-9]+/memtable=N/ /read_amp=[0-9.]+/read_amp=N/ /cache_hit=[0-9.]+/cache_hit=N/ /avg_key=[0-9.]+/avg_key=N/ /avg_value=[0-9.]+/avg_value=N/ /sstables=[0-9]+/sstables=N/ /size=[0-9]+/size=N/ /keys=[0-9]+/keys=N/
ANALYZE TABLE t2;

--echo # ANALYZE an empty table
CREATE TABLE t3 (
  id INT PRIMARY KEY
) ENGINE=TidesDB;

--replace_regex /total_keys=[0-9]+/total_keys=N/ /data_size=[0-9]+/data_size=N/ /memtable=[0-9]+/memtable=N/ /read_amp=[0-9.]+/read_amp=N/ /cache_hit=[0-9.]+/cache_hit=N/ /avg_key=[0-9.]+/avg_key=N/ /avg_value=[0-9.]+/avg_value=N/ /sstables=[0-9]+/sstables=N/ /size=[0-9]+/size=N/ /keys=[0-9]+/keys=N/
ANALYZE TABLE t3;

--echo # Cleanup
DROP TABLE t1, t2, t3;
