--echo #
--echo # TidesDB estimate_rows_upper_bound() and Query Cache Tests
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Row estimate on empty table
CREATE TABLE t1 (
  id INT PRIMARY KEY,
  data VARCHAR(255)
) ENGINE=TidesDB;

--echo # Empty table should report 0 or small number
SELECT TABLE_ROWS FROM information_schema.tables
  WHERE table_schema = DATABASE() AND table_name = 't1';

--echo # Test 2: Row estimate after inserts
--disable_query_log
let $i = 1;
while ($i <= 100)
{
  eval INSERT INTO t1 VALUES ($i, CONCAT('data_', $i));
  inc $i;
}
--enable_query_log

--echo # Should report approximately 100 rows
--let $rows = `SELECT TABLE_ROWS FROM information_schema.tables WHERE table_schema = DATABASE() AND table_name = 't1'`
--echo # TABLE_ROWS is approximately 100

--echo # Verify actual count matches
SELECT COUNT(*) FROM t1;

--echo # Test 3: Row estimate after deletes
DELETE FROM t1 WHERE id > 50;
SELECT COUNT(*) FROM t1;

--echo # Test 4: Row estimate with secondary index
CREATE TABLE t2 (
  id INT PRIMARY KEY,
  name VARCHAR(100),
  INDEX idx_name (name)
) ENGINE=TidesDB;

--disable_query_log
let $i = 1;
while ($i <= 200)
{
  eval INSERT INTO t2 VALUES ($i, CONCAT('name_', $i MOD 20));
  inc $i;
}
--enable_query_log

SELECT COUNT(*) FROM t2;

--echo # EXPLAIN should show reasonable row estimates
--replace_column 1 # 2 # 3 # 4 # 5 # 6 # 7 # 8 # 9 # 10 #
EXPLAIN SELECT * FROM t2 WHERE name = 'name_5';

--echo # Test 5: Join with row estimates affecting plan
CREATE TABLE t3 (
  id INT PRIMARY KEY,
  val INT
) ENGINE=TidesDB;

INSERT INTO t3 VALUES (1, 10), (2, 20), (3, 30);

--replace_column 1 # 2 # 3 # 4 # 5 # 6 # 7 # 8 # 9 # 10 #
EXPLAIN SELECT * FROM t2 JOIN t3 ON t2.id = t3.id;

--echo # Cleanup
DROP TABLE t1, t2, t3;

--echo #
--echo # Row estimate tests completed!
--echo #
