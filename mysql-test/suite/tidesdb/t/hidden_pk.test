--echo #
--echo # TidesDB Hidden Primary Key Tests
--echo #
--echo # Tests for tables without explicit PRIMARY KEY
--echo # TidesDB uses an 8-byte auto-increment hidden PK
--echo #

# Check if TidesDB is available
--disable_query_log
--error 0,1286
CREATE TABLE tidesdb_check (id INT) ENGINE=TidesDB;
--enable_query_log
if (`SELECT COUNT(*) = 0 FROM information_schema.tables WHERE table_name = 'tidesdb_check'`)
{
  --skip TidesDB storage engine not available
}
DROP TABLE IF EXISTS tidesdb_check;

--echo # Test 1: Table without PRIMARY KEY
CREATE TABLE t1 (
  name VARCHAR(100),
  value INT
) ENGINE=TidesDB;

INSERT INTO t1 VALUES ('Alice', 100);
INSERT INTO t1 VALUES ('Bob', 200);
INSERT INTO t1 VALUES ('Charlie', 300);
SELECT * FROM t1 ORDER BY name;

--echo # Test 2: UPDATE on table without PK
UPDATE t1 SET value = 150 WHERE name = 'Alice';
SELECT * FROM t1 ORDER BY name;

--echo # Test 3: DELETE on table without PK
DELETE FROM t1 WHERE name = 'Bob';
SELECT * FROM t1 ORDER BY name;

--echo # Test 4: Duplicate values allowed (no unique constraint)
INSERT INTO t1 VALUES ('Alice', 999);
SELECT * FROM t1 ORDER BY name, value;

--echo # Test 5: Table scan works correctly
SELECT COUNT(*) FROM t1;
SELECT * FROM t1 WHERE value > 100 ORDER BY value;

--echo # Test 6: Secondary index on table without PK
DROP TABLE t1;
CREATE TABLE t1 (
  name VARCHAR(100),
  value INT,
  INDEX idx_value (value)
) ENGINE=TidesDB;

INSERT INTO t1 VALUES ('A', 10), ('B', 20), ('C', 30), ('D', 20);
SELECT * FROM t1 WHERE value = 20 ORDER BY name;
SELECT * FROM t1 WHERE value >= 20 ORDER BY value, name;

--echo # Test 7: TRUNCATE table without PK
TRUNCATE TABLE t1;
INSERT INTO t1 VALUES ('New', 100);
SELECT * FROM t1;

--echo # Cleanup
DROP TABLE t1;

--echo #
--echo # Hidden PK tests completed!
--echo #
