name: MySQL Test Suite

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "TidesDB Engine Tests"
            engine: "TidesDB"
            suite: ""
            test: "tidesdb"
          - name: "Engine Funcs Suite (TidesDB)"
            engine: "TidesDB"
            suite: "engines/funcs"
            test: ""
          - name: "Engine IUDS Suite (TidesDB)"
            engine: "TidesDB"
            suite: "engines/iuds"
            test: ""
          - name: "Basic Tests (Default Engine)"
            engine: ""
            suite: ""
            test: "1st,create,insert,select,update,delete"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libncurses5-dev \
          libssl-dev \
          libreadline-dev \
          zlib1g-dev \
          liblz4-dev \
          libzstd-dev \
          libsnappy-dev \
          bison \
          perl \
          libaio-dev \
          libcurl4-openssl-dev

    - name: Install TidesDB library
      run: |
        # Clone and build TidesDB if not available as a package
        if ! pkg-config --exists tidesdb 2>/dev/null; then
          echo "Building TidesDB from source..."
          git clone https://github.com/tidesdb/tidesdb.git /tmp/tidesdb
          cd /tmp/tidesdb
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          sudo make install
          sudo ldconfig
        fi

    - name: Configure MySQL with TidesDB
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DWITH_SSL=system \
          -DWITH_ZLIB=system \
          -DWITH_TIDESDB=1 \
          -DDEFAULT_STORAGE_ENGINE=TidesDB

    - name: Build MySQL
      run: |
        cd build
        make -j$(nproc)

    - name: Run Tests - ${{ matrix.name }}
      run: |
        cd mysql-test
        
        # Build test command
        TEST_CMD="perl mysql-test-run.pl --force --retry=1 --max-test-fail=10"
        
        # Add engine option if specified
        if [ -n "${{ matrix.engine }}" ]; then
          TEST_CMD="$TEST_CMD --mysqld=--default-storage-engine=${{ matrix.engine }}"
        fi
        
        # Add suite option if specified
        if [ -n "${{ matrix.suite }}" ]; then
          TEST_CMD="$TEST_CMD --suite=${{ matrix.suite }}"
        fi
        
        # Add specific tests if specified
        if [ -n "${{ matrix.test }}" ]; then
          TEST_CMD="$TEST_CMD ${{ matrix.test }}"
        fi
        
        echo "Running: $TEST_CMD"
        $TEST_CMD

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.name }}
        path: |
          mysql-test/var/log/
          mysql-test/var/*.log
        retention-days: 7

  # Quick smoke test job that runs first
  smoke-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libncurses5-dev \
          libssl-dev \
          libreadline-dev \
          zlib1g-dev \
          liblz4-dev \
          libzstd-dev \
          libsnappy-dev \
          bison \
          perl \
          libaio-dev

    - name: Install TidesDB library
      run: |
        git clone https://github.com/tidesdb/tidesdb.git /tmp/tidesdb
        cd /tmp/tidesdb
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Configure and Build
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_TIDESDB=1
        make -j$(nproc)

    - name: Run TidesDB Smoke Test
      run: |
        cd mysql-test
        perl mysql-test-run.pl --force tidesdb

  # Full test suite (runs on schedule or manual trigger)
  full-test-suite:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libncurses5-dev \
          libssl-dev \
          libreadline-dev \
          zlib1g-dev \
          liblz4-dev \
          libzstd-dev \
          libsnappy-dev \
          bison \
          perl \
          libaio-dev \
          libcurl4-openssl-dev

    - name: Install TidesDB library
      run: |
        git clone https://github.com/tidesdb/tidesdb.git /tmp/tidesdb
        cd /tmp/tidesdb
        mkdir build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Configure and Build
      run: |
        mkdir -p build
        cd build
        cmake .. \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DWITH_SSL=system \
          -DWITH_TIDESDB=1
        make -j$(nproc)

    - name: Run Full Test Suite with TidesDB
      run: |
        cd mysql-test
        perl mysql-test-run.pl \
          --force \
          --retry=2 \
          --max-test-fail=50 \
          --parallel=auto \
          --mysqld=--default-storage-engine=TidesDB \
          --skip-test=ndb \
          --skip-test=rpl_ndb
      timeout-minutes: 180

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: full-test-results
        path: |
          mysql-test/var/log/
          mysql-test/var/*.log
        retention-days: 14
