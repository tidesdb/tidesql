name: MariaDB TidesDB Storage Engine Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout TideSQL
      uses: actions/checkout@v4
      with:
        path: tidesql

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          libncurses5-dev \
          libssl-dev \
          libxml2-dev \
          zlib1g-dev \
          libevent-dev \
          libcurl4-openssl-dev \
          liblz4-dev \
          libzstd-dev \
          libsnappy-dev \
          bison \
          gnutls-dev \
          libboost-dev \
          libpcre2-dev \
          libpmem-dev \
          libjemalloc-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install dependencies per MariaDB official docs + TidesDB requirements
        brew install \
          bison \
          byacc \
          cmake \
          git \
          gnutls \
          libxml2 \
          m4 \
          openssl@3 \
          pcre \
          pcre2 \
          zlib \
          zstd \
          ninja \
          ncurses \
          snappy \
          lz4
        
        # Set up Homebrew base directory (differs between Intel and Apple Silicon)
        if [ $(uname -m) = "x86_64" ]; then
          HOMEBREW_BASE_DIR="/usr/local"
        else
          HOMEBREW_BASE_DIR="/opt/homebrew"
        fi
        echo "HOMEBREW_BASE_DIR=${HOMEBREW_BASE_DIR}" >> $GITHUB_ENV
        
        # Add bison to PATH (use Apple's native clang, not Homebrew LLVM)
        echo "${HOMEBREW_BASE_DIR}/opt/bison/bin" >> $GITHUB_PATH

    - name: Cache vcpkg packages (Windows)
      if: runner.os == 'Windows'
      uses: actions/cache@v4
      with:
        path: |
          C:/vcpkg/installed
          C:/vcpkg/packages
        key: vcpkg-windows-x64-${{ hashFiles('.github/workflows/mariadb-test.yml') }}
        restore-keys: |
          vcpkg-windows-x64-

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        choco install -y strawberryperl
        choco install -y diffutils
        
        # Install WinFlexBison from GitHub releases (SourceForge is blocked by Cloudflare)
        # Download and extract to C:\GnuWin32 (path without spaces as required by MariaDB)
        $wfbZip = "$env:TEMP\winflexbison.zip"
        $wfbDir = "C:\GnuWin32"
        New-Item -ItemType Directory -Force -Path $wfbDir | Out-Null
        Invoke-WebRequest -Uri "https://github.com/lexxmark/winflexbison/releases/download/v2.5.25/win_flex_bison-2.5.25.zip" -OutFile $wfbZip
        Expand-Archive -Path $wfbZip -DestinationPath $wfbDir -Force
        
        # Create bison.exe and flex.exe copies (CMake FindBISON looks for 'bison', not 'win_bison')
        Copy-Item "$wfbDir\win_bison.exe" "$wfbDir\bison.exe"
        Copy-Item "$wfbDir\win_flex.exe" "$wfbDir\flex.exe"
        
        # Add to PATH
        echo "C:\GnuWin32" >> $env:GITHUB_PATH
        
        vcpkg install zstd:x64-windows lz4:x64-windows snappy:x64-windows pthreads:x64-windows curl:x64-windows bzip2:x64-windows libxml2:x64-windows boost:x64-windows openssl:x64-windows liblzma:x64-windows
        echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $env:GITHUB_ENV
        echo "TIDESDB_ROOT=C:/Program Files/tidesdb" >> $env:GITHUB_ENV

    - name: Get latest MariaDB release tag
      id: mariadb-release
      shell: bash
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/MariaDB/server/releases/latest | jq -r '.tag_name')
        echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        echo "Latest MariaDB release: ${LATEST_TAG}"

    - name: Clone MariaDB server
      shell: bash
      run: |
        git clone --depth 1 --branch ${{ steps.mariadb-release.outputs.tag }} https://github.com/MariaDB/server.git mariadb-server
        cd mariadb-server
        git submodule update --init --recursive --depth 1

    - name: Install TidesDB library (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Install TidesDB library (macOS)
      if: runner.os == 'macOS'
      run: |
        # Set SDKROOT to fix C++ header search path issues on macOS
        export SDKROOT=$(xcrun --show-sdk-path)
        
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build && cd build
        cmake .. -DCMAKE_OSX_SYSROOT=${SDKROOT} -DOPENSSL_ROOT_DIR=${HOMEBREW_BASE_DIR}/opt/openssl@3
        make -j$(sysctl -n hw.ncpu)
        sudo make install

    - name: Install TidesDB library (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=%VCPKG_INSTALLATION_ROOT%/scripts/buildsystems/vcpkg.cmake
        cmake --build . --config Release
        cmake --install . --config Release

    - name: Copy TidesDB storage engine to MariaDB (Unix)
      if: runner.os != 'Windows'
      run: |
        cp -r tidesql/tidesdb mariadb-server/storage/
        cp -r tidesql/mysql-test/suite/tidesdb mariadb-server/mysql-test/suite/

    - name: Copy TidesDB storage engine to MariaDB (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        xcopy /E /I tidesql\tidesdb mariadb-server\storage\tidesdb
        xcopy /E /I tidesql\mysql-test\suite\tidesdb mariadb-server\mysql-test\suite\tidesdb

    - name: Build MariaDB with TidesDB plugin (Ubuntu)
      if: runner.os == 'Linux'
      working-directory: mariadb-server
      run: |
        mkdir -p build && cd build
        cmake .. \
          -DPLUGIN_TIDESDB=DYNAMIC \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DPLUGIN_ROCKSDB=NO \
          -DPLUGIN_MROONGA=NO \
          -DPLUGIN_SPIDER=NO \
          -DPLUGIN_COLUMNSTORE=NO \
          -DWITH_UNIT_TESTS=OFF
        make -j$(nproc)

    - name: Build MariaDB with TidesDB plugin (macOS)
      if: runner.os == 'macOS'
      working-directory: mariadb-server
      run: |
        # Set SDKROOT to fix C++ header search path issues on macOS
        export SDKROOT=$(xcrun --show-sdk-path)
        
        # Use mariadb-build directory (macOS has case-insensitive filesystem, BUILD exists)
        mkdir -p mariadb-build && cd mariadb-build
        cmake .. \
          -DCMAKE_OSX_SYSROOT=${SDKROOT} \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DMYSQL_MAINTAINER_MODE=OFF \
          -DPLUGIN_TIDESDB=DYNAMIC \
          -DPLUGIN_ARCHIVE=NO \
          -DPLUGIN_MROONGA=NO \
          -DPLUGIN_CONNECT=NO \
          -DPLUGIN_SPIDER=NO \
          -DPLUGIN_ROCKSDB=NO \
          -DPLUGIN_OQGRAPH=NO \
          -DPLUGIN_TOKUDB=NO \
          -DPLUGIN_COLUMNSTORE=NO \
          -DWITH_UNIT_TESTS=OFF \
          -DCONC_WITH_UNITTEST=OFF \
          -DWITH_MARIABACKUP=OFF \
          -DWITH_EMBEDDED_SERVER=OFF \
          -DWITH_SSL=bundled \
          -DWITH_PCRE=bundled \
          -G Ninja
        cmake --build . --parallel $(sysctl -n hw.ncpu)

    - name: Build MariaDB with TidesDB plugin (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      working-directory: mariadb-server
      env:
        TIDESDB_ROOT: C:/Program Files/tidesdb
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DPLUGIN_TIDESDB=DYNAMIC -DPLUGIN_ROCKSDB=NO -DPLUGIN_MROONGA=NO -DPLUGIN_SPIDER=NO -DPLUGIN_COLUMNSTORE=NO -DPLUGIN_CONNECT=NO -DWITH_UNIT_TESTS=OFF -DCMAKE_PREFIX_PATH="C:/Program Files/tidesdb;%VCPKG_INSTALLATION_ROOT%/installed/x64-windows" -DCMAKE_INCLUDE_PATH="C:/Program Files/tidesdb/include"
        cmake --build . --config RelWithDebInfo --parallel

    - name: Run TidesDB test suite (Linux)
      if: runner.os == 'Linux'
      working-directory: mariadb-server/build
      run: |
        ./mysql-test/mtr --suite=tidesdb --parallel=4 --force --retry=1

    - name: Run TidesDB test suite (macOS)
      if: runner.os == 'macOS'
      working-directory: mariadb-server/mariadb-build
      run: |
        ./mysql-test/mtr --suite=tidesdb --parallel=4 --force --retry=1

    - name: Run TidesDB test suite (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      working-directory: mariadb-server/build
      run: |
        perl mysql-test\mysql-test-run.pl --suite=tidesdb --parallel=4 --force --retry=1
