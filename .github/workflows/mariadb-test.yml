name: MariaDB TidesDB Storage Engine Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout TidesQL
      uses: actions/checkout@v4
      with:
        path: tidesql

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          libncurses5-dev \
          libssl-dev \
          libxml2-dev \
          zlib1g-dev \
          libevent-dev \
          libcurl4-openssl-dev \
          liblz4-dev \
          libzstd-dev \
          libsnappy-dev \
          bison \
          gnutls-dev \
          libboost-dev \
          libpcre2-dev \
          libpmem-dev \
          libjemalloc-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install \
          cmake \
          openssl@3 \
          lz4 \
          zstd \
          snappy \
          bison \
          boost \
          pcre2 \
          libevent \
          jemalloc \
          gnutls
        echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        choco install -y strawberryperl
        choco install -y winflexbison3

    - name: Get latest MariaDB release tag
      id: mariadb-release
      shell: bash
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/MariaDB/server/releases/latest | jq -r '.tag_name')
        echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        echo "Latest MariaDB release: ${LATEST_TAG}"

    - name: Clone MariaDB server
      shell: bash
      run: |
        git clone --depth 1 --branch ${{ steps.mariadb-release.outputs.tag }} https://github.com/MariaDB/server.git mariadb-server
        cd mariadb-server
        git submodule update --init --recursive --depth 1

    - name: Install TidesDB library (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Install TidesDB library (macOS)
      if: runner.os == 'macOS'
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build && cd build
        cmake .. -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
        make -j$(sysctl -n hw.ncpu)
        sudo make install

    - name: Install TidesDB library (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64
        cmake --build . --config Release
        cmake --install . --config Release

    - name: Copy TidesDB storage engine to MariaDB (Unix)
      if: runner.os != 'Windows'
      run: |
        cp -r tidesql/tidesdb mariadb-server/storage/
        cp -r tidesql/mysql-test/suite/tidesdb mariadb-server/mysql-test/suite/

    - name: Copy TidesDB storage engine to MariaDB (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        xcopy /E /I tidesql\tidesdb mariadb-server\storage\tidesdb
        xcopy /E /I tidesql\mysql-test\suite\tidesdb mariadb-server\mysql-test\suite\tidesdb

    - name: Build MariaDB with TidesDB plugin (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        cd mariadb-server
        mkdir build && cd build
        cmake .. -DPLUGIN_TIDESDB=DYNAMIC -DCMAKE_BUILD_TYPE=RelWithDebInfo
        make -j$(nproc)

    - name: Build MariaDB with TidesDB plugin (macOS)
      if: runner.os == 'macOS'
      run: |
        cd mariadb-server
        mkdir build && cd build
        cmake .. \
          -DPLUGIN_TIDESDB=DYNAMIC \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
          -DWITH_SSL=$(brew --prefix openssl@3)
        make -j$(sysctl -n hw.ncpu)

    - name: Build MariaDB with TidesDB plugin (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cd mariadb-server
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DPLUGIN_TIDESDB=DYNAMIC
        cmake --build . --config RelWithDebInfo --parallel

    - name: Run TidesDB test suite (Unix)
      if: runner.os != 'Windows'
      run: |
        cd mariadb-server/build
        ./mysql-test/mtr --suite=tidesdb --parallel=4 --force --retry=1

    - name: Run TidesDB test suite (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        cd mariadb-server\build
        perl mysql-test\mysql-test-run.pl --suite=tidesdb --parallel=4 --force --retry=1
