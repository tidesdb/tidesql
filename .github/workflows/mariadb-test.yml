name: MariaDB TidesDB Storage Engine Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: Checkout TidesQL
      uses: actions/checkout@v4
      with:
        path: tidesql

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          libncurses5-dev \
          libssl-dev \
          libxml2-dev \
          zlib1g-dev \
          libevent-dev \
          libcurl4-openssl-dev \
          liblz4-dev \
          libzstd-dev \
          libsnappy-dev \
          bison \
          gnutls-dev \
          libboost-dev \
          libpcre2-dev \
          libpmem-dev \
          libjemalloc-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install \
          llvm \
          cmake \
          openssl@3 \
          lz4 \
          zstd \
          snappy \
          bison \
          boost \
          pcre2 \
          libevent \
          jemalloc \
          gnutls \
          libxml2 \
          zlib \
          ncurses \
          curl \
          xz \
          lzo
        echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
        echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH
        # Export Homebrew prefix for later steps
        echo "HOMEBREW_PREFIX=$(brew --prefix)" >> $GITHUB_ENV

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
        choco install -y strawberryperl
        # Install GnuWin32 bison (provides bison.exe that CMake can find)
        choco install -y gnuwin32-bison.install
        vcpkg install zstd:x64-windows lz4:x64-windows snappy:x64-windows pthreads:x64-windows curl:x64-windows bzip2:x64-windows libxml2:x64-windows boost:x64-windows
        echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $env:GITHUB_ENV
        echo "TIDESDB_ROOT=C:/Program Files/tidesdb" >> $env:GITHUB_ENV
        # Add GnuWin32 bison to PATH
        echo "C:\Program Files (x86)\GnuWin32\bin" >> $env:GITHUB_PATH

    - name: Get latest MariaDB release tag
      id: mariadb-release
      shell: bash
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/MariaDB/server/releases/latest | jq -r '.tag_name')
        echo "tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
        echo "Latest MariaDB release: ${LATEST_TAG}"

    - name: Clone MariaDB server
      shell: bash
      run: |
        git clone --depth 1 --branch ${{ steps.mariadb-release.outputs.tag }} https://github.com/MariaDB/server.git mariadb-server
        cd mariadb-server
        git submodule update --init --recursive --depth 1

    - name: Install TidesDB library (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Install TidesDB library (macOS)
      if: runner.os == 'macOS'
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build && cd build
        cmake .. \
          -DCMAKE_C_COMPILER=$(brew --prefix llvm)/bin/clang \
          -DCMAKE_CXX_COMPILER=$(brew --prefix llvm)/bin/clang++ \
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3)
        make -j$(sysctl -n hw.ncpu)
        sudo make install

    - name: Install TidesDB library (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        git clone --depth 1 https://github.com/tidesdb/tidesdb.git tidesdb-lib
        cd tidesdb-lib
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_TOOLCHAIN_FILE=%VCPKG_INSTALLATION_ROOT%/scripts/buildsystems/vcpkg.cmake
        cmake --build . --config Release
        cmake --install . --config Release

    - name: Copy TidesDB storage engine to MariaDB (Unix)
      if: runner.os != 'Windows'
      run: |
        cp -r tidesql/tidesdb mariadb-server/storage/
        cp -r tidesql/mysql-test/suite/tidesdb mariadb-server/mysql-test/suite/

    - name: Copy TidesDB storage engine to MariaDB (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        xcopy /E /I tidesql\tidesdb mariadb-server\storage\tidesdb
        xcopy /E /I tidesql\mysql-test\suite\tidesdb mariadb-server\mysql-test\suite\tidesdb

    - name: Build MariaDB with TidesDB plugin (Ubuntu)
      if: runner.os == 'Linux'
      working-directory: mariadb-server
      run: |
        mkdir -p build && cd build
        cmake .. \
          -DPLUGIN_TIDESDB=DYNAMIC \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DPLUGIN_ROCKSDB=NO \
          -DPLUGIN_MROONGA=NO \
          -DPLUGIN_SPIDER=NO \
          -DPLUGIN_COLUMNSTORE=NO \
          -DWITH_UNIT_TESTS=OFF
        make -j$(nproc)

    - name: Build MariaDB with TidesDB plugin (macOS)
      if: runner.os == 'macOS'
      working-directory: mariadb-server
      run: |
        LLVM_PREFIX=$(brew --prefix llvm)
        mkdir -p build && cd build
        cmake .. \
          -DCMAKE_C_COMPILER=${LLVM_PREFIX}/bin/clang \
          -DCMAKE_CXX_COMPILER=${LLVM_PREFIX}/bin/clang++ \
          -DCMAKE_EXE_LINKER_FLAGS="-L${LLVM_PREFIX}/lib/c++ -Wl,-rpath,${LLVM_PREFIX}/lib/c++ -L${LLVM_PREFIX}/lib -L${LLVM_PREFIX}/lib/unwind -lunwind" \
          -DCMAKE_SHARED_LINKER_FLAGS="-L${LLVM_PREFIX}/lib/c++ -Wl,-rpath,${LLVM_PREFIX}/lib/c++ -L${LLVM_PREFIX}/lib -L${LLVM_PREFIX}/lib/unwind -lunwind" \
          -DPLUGIN_TIDESDB=DYNAMIC \
          -DCMAKE_BUILD_TYPE=RelWithDebInfo \
          -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) \
          -DWITH_SSL=$(brew --prefix openssl@3) \
          -DCURSES_LIBRARY=$(brew --prefix ncurses)/lib/libncurses.dylib \
          -DCURSES_INCLUDE_PATH=$(brew --prefix ncurses)/include \
          -DPLUGIN_ROCKSDB=NO \
          -DPLUGIN_MROONGA=NO \
          -DPLUGIN_SPIDER=NO \
          -DPLUGIN_COLUMNSTORE=NO \
          -DPLUGIN_CONNECT=NO \
          -DWITH_UNIT_TESTS=OFF
        make -j$(sysctl -n hw.ncpu)

    - name: Build MariaDB with TidesDB plugin (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      working-directory: mariadb-server
      env:
        TIDESDB_ROOT: C:/Program Files/tidesdb
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 17 2022" -A x64 -DPLUGIN_TIDESDB=DYNAMIC -DPLUGIN_ROCKSDB=NO -DPLUGIN_MROONGA=NO -DPLUGIN_SPIDER=NO -DPLUGIN_COLUMNSTORE=NO -DWITH_UNIT_TESTS=OFF -DCMAKE_PREFIX_PATH="C:/Program Files/tidesdb;%VCPKG_INSTALLATION_ROOT%/installed/x64-windows"
        cmake --build . --config RelWithDebInfo --parallel

    - name: Run TidesDB test suite (Unix)
      if: runner.os != 'Windows'
      working-directory: mariadb-server/build
      run: |
        ./mysql-test/mtr --suite=tidesdb --parallel=4 --force --retry=1

    - name: Run TidesDB test suite (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      working-directory: mariadb-server/build
      run: |
        perl mysql-test\mysql-test-run.pl --suite=tidesdb --parallel=4 --force --retry=1
