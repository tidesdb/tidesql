name: TideSQL CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    
    strategy:
      matrix:
        mariadb-version: ['10.11', '11.2']
    
    services:
      mariadb:
        image: mariadb:${{ matrix.mariadb-version }}
        env:
          MARIADB_ROOT_PASSWORD: root
          MARIADB_DATABASE: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="healthcheck.sh --connect --innodb_initialized"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libmariadb-dev \
          mariadb-client \
          libzstd-dev \
          liblz4-dev \
          libsnappy-dev \
          pkg-config

    - name: Get MariaDB source for headers
      run: |
        # Download MariaDB server source for storage engine headers
        MARIADB_VERSION="${{ matrix.mariadb-version }}"
        if [[ "$MARIADB_VERSION" == "10.11" ]]; then
          FULL_VERSION="10.11.6"
        else
          FULL_VERSION="11.2.2"
        fi
        
        wget -q "https://archive.mariadb.org/mariadb-${FULL_VERSION}/source/mariadb-${FULL_VERSION}.tar.gz"
        tar -xzf "mariadb-${FULL_VERSION}.tar.gz"
        echo "MARIADB_SOURCE=$(pwd)/mariadb-${FULL_VERSION}" >> $GITHUB_ENV

    - name: Build TidesDB
      run: |
        # Clone and build TidesDB
        git clone https://github.com/tidesdb/tidesdb.git /tmp/tidesdb
        cd /tmp/tidesdb
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j$(nproc)
        sudo cmake --install build
        sudo ldconfig
        
        # Set environment variables for tidesql build
        echo "TIDESDB_DIR=/usr/local" >> $GITHUB_ENV

    - name: Build TideSQL plugin
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DMYSQL_SOURCE="${MARIADB_SOURCE}" \
          -DTIDESDB_DIR="${TIDESDB_DIR}"
        cmake --build build -j$(nproc)

    - name: Get MariaDB plugin directory
      run: |
        PLUGIN_DIR=$(mariadb -u root -proot -h 127.0.0.1 -N -e "SELECT @@plugin_dir;")
        echo "PLUGIN_DIR=${PLUGIN_DIR}" >> $GITHUB_ENV
        echo "Plugin directory: ${PLUGIN_DIR}"

    - name: Install TideSQL plugin
      run: |
        sudo cp build/ha_tidesql.so "${PLUGIN_DIR}/"
        sudo chmod 755 "${PLUGIN_DIR}/ha_tidesql.so"

    - name: Run tests
      env:
        MYSQL_USER: root
        MYSQL_PASSWORD: root
        MYSQL_HOST: 127.0.0.1
        MYSQL_PORT: 3306
        PLUGIN_PATH: ${{ env.PLUGIN_DIR }}/ha_tidesql.so
      run: |
        chmod +x scripts/test_tidesql.sh
        ./scripts/test_tidesql.sh

  build-only:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libmariadb-dev \
          libzstd-dev \
          liblz4-dev \
          libsnappy-dev \
          pkg-config

    - name: Download MariaDB source
      run: |
        wget -q "https://archive.mariadb.org/mariadb-10.11.6/source/mariadb-10.11.6.tar.gz"
        tar -xzf "mariadb-10.11.6.tar.gz"
        echo "MARIADB_SOURCE=$(pwd)/mariadb-10.11.6" >> $GITHUB_ENV

    - name: Build TidesDB
      run: |
        git clone https://github.com/tidesdb/tidesdb.git /tmp/tidesdb
        cd /tmp/tidesdb
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build -j$(nproc)
        sudo cmake --install build
        sudo ldconfig

    - name: Build TideSQL plugin
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DMYSQL_SOURCE="${MARIADB_SOURCE}"
        cmake --build build -j$(nproc)

    - name: Verify plugin built
      run: |
        ls -la build/ha_tidesql.so
        file build/ha_tidesql.so

    - name: Upload plugin artifact
      uses: actions/upload-artifact@v4
      with:
        name: ha_tidesql-${{ matrix.os }}
        path: build/ha_tidesql.so
        retention-days: 7
